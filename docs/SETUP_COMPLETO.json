{
  "metadata": {
    "title": "Configuraci√≥n Completa de Mercado Pago - Resumen",
    "path": "docs/SETUP_COMPLETO.md",
    "category": "setup",
    "tags": [
      "setup"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "SETUP_COMPLETO"
  },
  "content": "# Configuraci√≥n Completa de Mercado Pago - Resumen\r\n\r\n## ‚úÖ Estado Actual - TODO COMPLETADO\r\n\r\n### Configuraci√≥n Autom√°tica Completada\r\n\r\n1. ‚úÖ **Tabla `payment_links` creada** v√≠a MCP de Supabase\r\n   - Migraci√≥n aplicada\r\n   - Estructura completa con √≠ndices\r\n   - Pol√≠ticas RLS configuradas\r\n   - **Estado**: ‚úÖ Funcionando correctamente\r\n\r\n2. ‚úÖ **Archivo `.env.local` creado**\r\n   - Script ejecutado: `scripts/create-env-local.ps1`\r\n   - Todas las variables de entorno configuradas\r\n\r\n3. ‚úÖ **7 Secrets configurados en Supabase:**\r\n   - `MP_CLIENT_ID`\r\n   - `MP_CLIENT_SECRET`\r\n   - `MP_WEBHOOK_SECRET`\r\n   - `MP_TOKEN_KEY`\r\n   - `PUBLIC_EDGE_BASE_URL`\r\n   - `NEXT_PUBLIC_APP_URL`\r\n   - `SERVICE_ROLE_KEY`\r\n\r\n4. ‚úÖ **11 Edge Functions desplegadas:**\r\n   - `auth-mp-connect`\r\n   - `auth-mp-callback`\r\n   - `mp-disconnect`\r\n   - `mp-create-preference`\r\n   - `mercadopago-webhook`\r\n   - `create-payment-link` ‚úÖ **Funcionando correctamente**\r\n   - `get-payment-link-config` ‚úÖ **Funcionando correctamente (desplegada con --no-verify-jwt)**\r\n   - `public-get-salon-services`\r\n   - `public-get-salon-stylists`\r\n   - `public-get-availability`\r\n   - `public-create-appointment`\r\n\r\n5. ‚úÖ **Webhook configurado en Mercado Pago** (modo prueba)\r\n   - URL: `https://hawpywnmkatwlcbtffrg.supabase.co/functions/v1/mercadopago-webhook`\r\n   - Eventos configurados: Pagos, Vinculaci√≥n, Alertas, Reclamos, Card Updater, Contracargos, Order, √ìrdenes comerciales\r\n   - Clave secreta configurada\r\n\r\n6. ‚úÖ **Funciones RPC creadas en PostgreSQL:**\r\n   - `public.create_payment_link` ‚úÖ Funcionando correctamente\r\n   - `public.get_payment_link_by_token` ‚úÖ Funcionando correctamente\r\n\r\n### Estado de Payment Links\r\n\r\n**‚úÖ Payment Links funcionando correctamente:**\r\n- Generaci√≥n de links: ‚úÖ Funciona\r\n- Validaci√≥n de tokens: ‚úÖ Funciona\r\n- Acceso p√∫blico al checkout: ‚úÖ Funciona\r\n- Formulario de checkout se muestra correctamente\r\n\r\n**‚ö†Ô∏è Pendiente:**\r\n- Configurar servicios y precios para probar el flujo completo de reserva\r\n- Verificar integraci√≥n con Mercado Pago en el checkout p√∫blico\r\n\r\n**üìù Documentaci√≥n detallada:**\r\n- Ver `docs/INTEGRACION_PAYMENT_LINKS.md` para detalles completos del proceso de implementaci√≥n\r\n\r\n---\r\n\r\n## Proceso de Integraci√≥n de Payment Links\r\n\r\n### Herramientas Utilizadas\r\n\r\n1. **Supabase MCP (Model Context Protocol)**\r\n   - Conexi√≥n mediante MCP de Supabase integrado en Cursor\r\n   - Proyecto ID: `hawpywnmkatwlcbtffrg`\r\n   - Funciones principales:\r\n     - `mcp_supabase_apply_migration`: Aplicar migraciones SQL\r\n     - `mcp_supabase_execute_sql`: Ejecutar queries SQL directos\r\n     - `mcp_supabase_get_logs`: Revisar logs de Edge Functions\r\n     - `mcp_supabase_list_tables`: Verificar estructura de la base de datos\r\n     - `mcp_supabase_list_extensions`: Verificar extensiones instaladas\r\n\r\n2. **Supabase CLI**\r\n   - Comando: `npx --yes supabase functions deploy`\r\n   - Flags importantes:\r\n     - `--project-ref`: ID del proyecto Supabase\r\n     - `--workdir`: Directorio de trabajo\r\n     - `--no-verify-jwt`: Para funciones p√∫blicas sin autenticaci√≥n\r\n\r\n3. **Browser Extension MCP**\r\n   - Para probar el flujo completo en el navegador\r\n   - URL local: `http://192.168.100.50:3000`\r\n   - URL producci√≥n: `https://coreboard.vercel.app`\r\n\r\n### Problemas Encontrados y Soluciones\r\n\r\n1. **Formato bytea para token_hash**\r\n   - Problema: PostgREST no puede manejar bytea directamente desde JavaScript\r\n   - Soluci√≥n: Creaci√≥n de funci√≥n RPC que maneja bytea directamente en PostgreSQL\r\n\r\n2. **Extensi√≥n pgcrypto no disponible**\r\n   - Problema: `gen_random_bytes()` no estaba disponible\r\n   - Soluci√≥n: Habilitaci√≥n de extensi√≥n `pgcrypto` y uso de `extensions.gen_random_bytes()`\r\n\r\n3. **Nombre incorrecto de tabla organizations**\r\n   - Problema: La tabla se llama `app.orgs`, no `app.organizations`\r\n   - Soluci√≥n: Correcci√≥n de la funci√≥n RPC para usar `app.orgs`\r\n\r\n4. **Autenticaci√≥n requerida en get-payment-link-config**\r\n   - Problema: La Edge Function requer√≠a autenticaci√≥n, creando un c√≠rculo vicioso\r\n   - Soluci√≥n: Eliminaci√≥n de validaci√≥n de autenticaci√≥n y despliegue con `--no-verify-jwt`\r\n\r\n5. **Headers CORS**\r\n   - Problema: Las Edge Functions no ten√≠an headers CORS configurados\r\n   - Soluci√≥n: Agregado de headers CORS en ambas funciones\r\n\r\n**üìù Ver `docs/INTEGRACION_PAYMENT_LINKS.md` para detalles completos**\r\n\r\n---\r\n\r\n## Configuraci√≥n Actual (Sandbox/Prueba)\r\n\r\n### Secrets en Supabase (Modo Prueba)\r\n\r\n```env\r\nMP_CLIENT_ID=311317450627289\r\nMP_CLIENT_SECRET=ACAOfFSl4KkULdcRE6WlUUHMNwmqrVvq\r\nMP_WEBHOOK_SECRET=903fdd0640d1353e6ba6a9051798e93efd4ef39054a1699c2dc577511217dc5d\r\nMP_TOKEN_KEY=f9d2b8a0e1c4b39f772c5a6d84f09e3b51a27cb08e6d9354a7dcb61f92ad4b03\r\nPUBLIC_EDGE_BASE_URL=https://hawpywnmkatwlcbtffrg.supabase.co\r\nNEXT_PUBLIC_APP_URL=https://coreboard.vercel.app\r\nSERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\r\n```\r\n\r\n### Variables en `.env.local` (Frontend)\r\n\r\n```env\r\nNEXT_PUBLIC_SUPABASE_ANON_KEY=\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\r\nNEXT_PUBLIC_SUPABASE_URL=\"https://hawpywnmkatwlcbtffrg.supabase.co\"\r\nNEXT_PUBLIC_SUPABASE_FUNCTIONS_URL=\"https://hawpywnmkatwlcbtffrg.supabase.co/functions/v1\"\r\nNEXT_PUBLIC_APP_URL=\"https://coreboard.vercel.app\"\r\nMP_TEST_PUBLIC_KEY=\"TEST-0ca3aa64-6280-4f79-b276-b96ab1e3f561\"\r\n```\r\n\r\n---\r\n\r\n## Testing End-to-End\r\n\r\n### Gu√≠a Completa de Testing\r\n\r\nVer `MERCADOPAGO_TESTING.md` para:\r\n- ‚úÖ Paso 1: Verificar Conexi√≥n OAuth\r\n- ‚úÖ Paso 2: Generar Payment Link\r\n- ‚úÖ Paso 3: Probar Checkout P√∫blico (Flujo Completo)\r\n- ‚úÖ Paso 4: Verificar Webhook\r\n- ‚úÖ Paso 5: Probar Casos Edge\r\n\r\n**Resumen r√°pido:**\r\n1. CRM ‚Üí Configuraci√≥n ‚Üí Mercado Pago ‚Üí Conectar (cuenta: `TESTUSER5830222553060724396`)\r\n2. CRM ‚Üí Generar Link de Pago ‚Üí Copiar link\r\n3. Abrir link en modo inc√≥gnito ‚Üí Completar checkout ‚Üí Pagar con tarjeta `5031 7557 3453 0604`\r\n4. Verificar redirecci√≥n a `/payment/success` y turno confirmado en BD\r\n\r\n---\r\n\r\n## Preparaci√≥n para Producci√≥n\r\n\r\n### Checklist Pre-Producci√≥n\r\n\r\nAntes de pasar a producci√≥n, aseg√∫rate de:\r\n\r\n- [ ] **Testing completo realizado** (ver `MERCADOPAGO_TESTING.md`)\r\n- [ ] **Credenciales de producci√≥n obtenidas** de Mercado Pago\r\n- [ ] **Variables de entorno actualizadas** (ver secci√≥n abajo)\r\n- [ ] **Webhooks configurados en producci√≥n** (modo productivo)\r\n- [ ] **Monitoreo configurado** (logs, alertas)\r\n- [ ] **Documentaci√≥n actualizada** para el equipo\r\n\r\n---\r\n\r\n## Migraci√≥n de Prueba a Producci√≥n\r\n\r\n### Paso 1: Obtener Credenciales de Producci√≥n\r\n\r\n1. **Ir a Mercado Pago Dashboard:**\r\n   - https://www.mercadopago.com.ar/developers/panel/app/311317450627289/credentials/production\r\n   - Solicitar credenciales de producci√≥n (si no las tienes)\r\n\r\n2. **Copiar Credenciales:**\r\n   - **Client ID** (producci√≥n)\r\n   - **Client Secret** (producci√≥n)\r\n   - **Public Key** (producci√≥n)\r\n   - **Access Token** (producci√≥n) - opcional, se genera v√≠a OAuth\r\n\r\n3. **Generar Nueva Clave Secreta para Webhook:**\r\n   - Dashboard ‚Üí Webhooks ‚Üí Generar nueva clave secreta\r\n   - Guardar en lugar seguro (no reutilizar la de prueba)\r\n\r\n---\r\n\r\n### Paso 2: Actualizar Secrets en Supabase\r\n\r\n**‚ö†Ô∏è IMPORTANTE:** Actualizar todos los secrets con valores de producci√≥n.\r\n\r\n```bash\r\n# 1. Actualizar MP_CLIENT_ID (producci√≥n)\r\nsupabase secrets set MP_CLIENT_ID=[PRODUCTION_CLIENT_ID] --project-ref hawpywnmkatwlcbtffrg\r\n\r\n# 2. Actualizar MP_CLIENT_SECRET (producci√≥n)\r\nsupabase secrets set MP_CLIENT_SECRET=[PRODUCTION_CLIENT_SECRET] --project-ref hawpywnmkatwlcbtffrg\r\n\r\n# 3. Actualizar MP_WEBHOOK_SECRET (nueva clave de producci√≥n)\r\nsupabase secrets set MP_WEBHOOK_SECRET=[PRODUCTION_WEBHOOK_SECRET] --project-ref hawpywnmkatwlcbtffrg\r\n\r\n# 4. Actualizar MP_TOKEN_KEY (producci√≥n)\r\nsupabase secrets set MP_TOKEN_KEY=[PRODUCTION_TOKEN_KEY] --project-ref hawpywnmkatwlcbtffrg\r\n\r\n# 5. Verificar URLs (deben ser las de producci√≥n)\r\nsupabase secrets set PUBLIC_EDGE_BASE_URL=https://hawpywnmkatwlcbtffrg.supabase.co --project-ref hawpywnmkatwlcbtffrg\r\nsupabase secrets set NEXT_PUBLIC_APP_URL=https://coreboard.vercel.app --project-ref hawpywnmkatwlcbtffrg\r\n\r\n# 6. SERVICE_ROLE_KEY no cambia (es el mismo)\r\n```\r\n\r\n**Verificar que se actualizaron:**\r\n```bash\r\nsupabase secrets list --project-ref hawpywnmkatwlcbtffrg\r\n```\r\n\r\n---\r\n\r\n### Paso 3: Actualizar Variables en Frontend\r\n\r\n**Actualizar `.env.local` y variables en Vercel/plataforma de hosting:**\r\n\r\n```env\r\n# .env.local (producci√≥n)\r\nNEXT_PUBLIC_SUPABASE_ANON_KEY=\"[PRODUCTION_ANON_KEY]\"  # Mismo que ahora\r\nNEXT_PUBLIC_SUPABASE_URL=\"https://hawpywnmkatwlcbtffrg.supabase.co\"  # Mismo\r\nNEXT_PUBLIC_SUPABASE_FUNCTIONS_URL=\"https://hawpywnmkatwlcbtffrg.supabase.co/functions/v1\"  # Mismo\r\nNEXT_PUBLIC_APP_URL=\"https://coreboard.vercel.app\"  # URL de producci√≥n\r\nMP_TEST_PUBLIC_KEY=\"[PRODUCTION_PUBLIC_KEY]\"  # ‚ö†Ô∏è Cambiar a producci√≥n\r\n```\r\n\r\n**En Vercel:**\r\n1. Ir a Settings ‚Üí Environment Variables\r\n2. Actualizar todas las variables con valores de producci√≥n\r\n3. Redeployar aplicaci√≥n\r\n\r\n---\r\n\r\n### Paso 4: Configurar Webhook en Producci√≥n\r\n\r\n1. **Ir a Mercado Pago Dashboard:**\r\n   - https://www.mercadopago.com.ar/developers/panel/app/311317450627289/webhooks\r\n   - Cambiar tab a **\"Modo productivo\"**\r\n\r\n2. **Configurar Webhook:**\r\n   - URL: `https://hawpywnmkatwlcbtffrg.supabase.co/functions/v1/mercadopago-webhook`\r\n   - Seleccionar eventos:\r\n     - ‚úÖ `payment`\r\n     - ‚úÖ `mp-connect`\r\n     - ‚úÖ `order`\r\n     - ‚úÖ `merchant_order`\r\n     - ‚úÖ Otros eventos seg√∫n necesidad\r\n   - **Clave secreta:** Usar la nueva clave secreta de producci√≥n\r\n   - Guardar configuraci√≥n\r\n\r\n3. **Verificar Webhook:**\r\n   - Usar herramienta \"Simular notificaci√≥n\" con un pago real de prueba peque√±o\r\n   - Verificar que llega correctamente a la Edge Function\r\n\r\n---\r\n\r\n### Paso 5: Actualizar C√≥digo (Si es Necesario)\r\n\r\n**Revisar Edge Functions que usan credenciales:**\r\n\r\n1. **`mp-create-preference/index.ts`:**\r\n   - Verificar que usa `MP_TOKEN_KEY` correctamente\r\n   - No hay hardcodeo de credenciales de prueba\r\n\r\n2. **`mercadopago-webhook/index.ts`:**\r\n   - Verificar que valida `MP_WEBHOOK_SECRET` correctamente\r\n   - Usa la clave secreta del environment\r\n\r\n3. **Frontend:**\r\n   - Verificar que usa `MP_TEST_PUBLIC_KEY` desde env (no hardcodeado)\r\n   - Cambiar a `MP_PUBLIC_KEY` en producci√≥n si es necesario\r\n\r\n---\r\n\r\n### Paso 6: Testing Final en Producci√≥n\r\n\r\n**‚ö†Ô∏è Hacer pruebas con montos peque√±os antes de lanzar completamente**\r\n\r\n1. **Probar OAuth en Producci√≥n:**\r\n   - CRM ‚Üí Configuraci√≥n ‚Üí Mercado Pago ‚Üí Conectar\r\n   - Usar cuenta real de Mercado Pago (no test)\r\n   - Verificar que se conecta correctamente\r\n\r\n2. **Generar Payment Link:**\r\n   - CRM ‚Üí Generar Link de Pago\r\n   - Verificar que genera link correctamente\r\n\r\n3. **Probar Checkout con Pago Real (Monto M√≠nimo):**\r\n   - Abrir link en modo inc√≥gnito\r\n   - Completar checkout\r\n   - Pagar con tarjeta real (monto m√≠nimo: $1 ARS)\r\n   - Verificar que:\r\n     - Pago se procesa correctamente\r\n     - Webhook llega\r\n     - Turno se confirma\r\n     - Notificaci√≥n se env√≠a\r\n\r\n4. **Verificar Logs:**\r\n   - Supabase ‚Üí Edge Functions ‚Üí Logs\r\n   - Verificar que no hay errores\r\n   - Verificar que webhooks se procesan correctamente\r\n\r\n---\r\n\r\n## Checklist Final de Producci√≥n\r\n\r\n### Antes de Lanzar\r\n\r\n- [ ] ‚úÖ Credenciales de producci√≥n configuradas en Supabase\r\n- [ ] ‚úÖ Variables de entorno actualizadas en frontend\r\n- [ ] ‚úÖ Webhook configurado en modo productivo\r\n- [ ] ‚úÖ OAuth probado con cuenta real\r\n- [ ] ‚úÖ Payment link generado correctamente\r\n- [ ] ‚úÖ Checkout completo probado con pago real (monto m√≠nimo)\r\n- [ ] ‚úÖ Webhook procesa correctamente\r\n- [ ] ‚úÖ Turnos se confirman autom√°ticamente\r\n- [ ] ‚úÖ Logs monitoreados y sin errores\r\n- [ ] ‚úÖ Documentaci√≥n actualizada\r\n\r\n### Post-Lanzamiento\r\n\r\n- [ ] Monitorear logs diariamente primera semana\r\n- [ ] Verificar tasa de √©xito de pagos\r\n- [ ] Verificar que webhooks llegan correctamente\r\n- [ ] Revisar errores y ajustar seg√∫n necesidad\r\n\r\n---\r\n\r\n## Diferencias Clave: Prueba vs Producci√≥n\r\n\r\n| Aspecto | Prueba (Sandbox) | Producci√≥n |\r\n|---------|------------------|------------|\r\n| **Client ID** | `311317450627289` | [PRODUCTION_CLIENT_ID] |\r\n| **Client Secret** | `ACAOfFSl...` | [PRODUCTION_SECRET] |\r\n| **Webhook Secret** | `903fdd06...` | [NUEVA_CLAVE_PRODUCCION] |\r\n| **Token Key** | `f9d2b8a0...` | [PRODUCTION_TOKEN_KEY] |\r\n| **Public Key** | `TEST-0ca3aa64...` | [PRODUCTION_PUBLIC_KEY] |\r\n| **API URL** | `https://api.mercadopago.com` | `https://api.mercadopago.com` (mismo) |\r\n| **Cuentas** | TESTUSER* | Cuentas reales |\r\n| **Pagos** | Tarjetas de prueba | Tarjetas reales |\r\n| **Webhook URL** | Mismo | Mismo (misma Edge Function) |\r\n\r\n---\r\n\r\n## Rollback Plan\r\n\r\nSi algo sale mal en producci√≥n:\r\n\r\n1. **Revertir Secrets:**\r\n   ```bash\r\n   supabase secrets set MP_CLIENT_ID=311317450627289 --project-ref hawpywnmkatwlcbtffrg\r\n   supabase secrets set MP_CLIENT_SECRET=ACAOfFSl4KkULdcRE6WlUUHMNwmqrVvq --project-ref hawpywnmkatwlcbtffrg\r\n   # ... (revertir todos a valores de prueba)\r\n   ```\r\n\r\n2. **Revertir Variables en Frontend:**\r\n   - Vercel ‚Üí Environment Variables ‚Üí Revertir a valores de prueba\r\n   - Redeployar\r\n\r\n3. **Cambiar Webhook a Modo Prueba:**\r\n   - Mercado Pago Dashboard ‚Üí Webhooks ‚Üí Cambiar a modo prueba\r\n\r\n---\r\n\r\n## Monitoreo y Alertas\r\n\r\n### M√©tricas a Monitorear\r\n\r\n1. **Tasa de √âxito de OAuth:**\r\n   - Verificar que los usuarios pueden conectar sus cuentas\r\n   - Monitorear errores en `auth-mp-connect` y `auth-mp-callback`\r\n\r\n2. **Tasa de Generaci√≥n de Payment Links:**\r\n   - Verificar que se generan correctamente\r\n   - Monitorear errores en `create-payment-link`\r\n\r\n3. **Tasa de Conversi√≥n de Checkout:**\r\n   - Visitas a payment links vs pagos completados\r\n   - Monitorear errores en `public-create-appointment`\r\n\r\n4. **Tasa de √âxito de Pagos:**\r\n   - Pagos aprobados vs rechazados\r\n   - Monitorear webhooks recibidos vs procesados\r\n\r\n5. **Tiempo de Respuesta:**\r\n   - Edge Functions deben responder < 2 segundos\r\n   - Webhooks deben procesarse < 5 segundos\r\n\r\n### Alertas Recomendadas\r\n\r\n- ‚ùå Error rate > 5% en cualquier Edge Function\r\n- ‚ùå Webhook no recibido por > 10 minutos\r\n- ‚ùå Tiempo de respuesta > 5 segundos\r\n- ‚ùå Tasa de √©xito de pagos < 80%\r\n\r\n---\r\n\r\n## Documentaci√≥n Adicional\r\n\r\n- **Testing Completo:** Ver `MERCADOPAGO_TESTING.md`\r\n- **Troubleshooting:** Ver secci√≥n de troubleshooting en `MERCADOPAGO_TESTING.md`\r\n- **API Docs:** https://www.mercadopago.com.ar/developers/es/docs\r\n- **Supabase Docs:** https://supabase.com/docs\r\n\r\n---\r\n\r\n**√öltima actualizaci√≥n:** Configuraci√≥n completada ‚úÖ - Listo para producci√≥n despu√©s de testing completo\r\n",
  "sections": []
}