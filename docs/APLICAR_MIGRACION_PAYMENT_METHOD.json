{
  "metadata": {
    "title": "Migración: Actualizar payment_method para incluir 'mercadopago'",
    "path": "docs/APLICAR_MIGRACION_PAYMENT_METHOD.md",
    "category": "migration",
    "tags": [
      "migration"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "APLICAR_MIGRACION_PAYMENT_METHOD"
  },
  "content": "# Migración: Actualizar payment_method para incluir 'mercadopago'\r\n\r\n## Instrucciones\r\n\r\nEjecuta el siguiente SQL en el editor SQL de Supabase:\r\n\r\n```sql\r\n-- Migración: Actualizar constraints de payment_method para incluir 'mercadopago'\r\n-- Esta migración permite usar 'mercadopago' como método de pago\r\n\r\n-- ============================================================================\r\n-- 1. ACTUALIZAR CHECK CONSTRAINT EN app.payments\r\n-- ============================================================================\r\n-- Primero eliminar el constraint existente\r\nALTER TABLE app.payments \r\nDROP CONSTRAINT IF EXISTS payments_payment_method_check;\r\n\r\n-- Crear nuevo constraint que incluye 'mercadopago'\r\nALTER TABLE app.payments\r\nADD CONSTRAINT payments_payment_method_check \r\nCHECK (payment_method IN ('cash', 'card', 'transfer', 'mercadopago', 'other'));\r\n\r\n-- ============================================================================\r\n-- 2. ACTUALIZAR CHECK CONSTRAINT EN public.payments (si existe)\r\n-- ============================================================================\r\nALTER TABLE public.payments \r\nDROP CONSTRAINT IF EXISTS payments_payment_method_check;\r\n\r\nALTER TABLE public.payments\r\nADD CONSTRAINT payments_payment_method_check \r\nCHECK (payment_method IN ('cash', 'card', 'transfer', 'mercadopago', 'other'));\r\n\r\n-- ============================================================================\r\n-- 3. ACTUALIZAR TRIGGER PARA MAPEAR payment_method CORRECTAMENTE\r\n-- ============================================================================\r\nCREATE OR REPLACE FUNCTION app.generate_payment_on_complete()\r\nRETURNS TRIGGER\r\nLANGUAGE plpgsql\r\nAS $$\r\nDECLARE\r\n  v_appointment_total numeric;\r\n  v_payment_exists boolean;\r\n  v_payment_method text;\r\nBEGIN\r\n  -- Solo generar pago cuando turno se completa y no había estado completado antes\r\n  IF NEW.status = 'completed' AND (OLD.status IS NULL OR OLD.status != 'completed') THEN\r\n    -- Verificar si ya existe un pago para este appointment\r\n    SELECT EXISTS(\r\n      SELECT 1 FROM app.payments\r\n      WHERE appointment_id = NEW.id\r\n    ) INTO v_payment_exists;\r\n    \r\n    -- Si no existe pago, crear uno automáticamente\r\n    IF NOT v_payment_exists THEN\r\n      -- Obtener total_amount del appointment\r\n      v_appointment_total := COALESCE(NEW.total_amount, 0);\r\n      \r\n      -- Solo crear pago si hay un monto mayor a cero\r\n      IF v_appointment_total > 0 THEN\r\n        -- Mapear payment_method del appointment al formato de payments\r\n        v_payment_method := COALESCE(NEW.payment_method, 'cash');\r\n        \r\n        -- Validar y mapear el método de pago\r\n        IF v_payment_method NOT IN ('cash', 'card', 'transfer', 'mercadopago', 'other') THEN\r\n          v_payment_method := 'cash';\r\n        END IF;\r\n        \r\n        INSERT INTO app.payments (\r\n          org_id,\r\n          appointment_id,\r\n          amount,\r\n          payment_method,\r\n          processed_at,\r\n          created_by,\r\n          notes\r\n        ) VALUES (\r\n          NEW.org_id,\r\n          NEW.id,\r\n          v_appointment_total,\r\n          v_payment_method,\r\n          NOW(),\r\n          NEW.created_by,\r\n          'Pago automático al completar turno'\r\n        );\r\n      END IF;\r\n    END IF;\r\n  END IF;\r\n  \r\n  RETURN NEW;\r\nEND;\r\n$$;\r\n```\r\n\r\n## Cambios realizados\r\n\r\n1. ✅ Actualizado `schema.sql` para incluir 'mercadopago' en el constraint\r\n2. ✅ Actualizado el trigger `generate_payment_on_complete` en `schema.sql`\r\n3. ✅ Actualizado el tipo `Payment` en `usePayments.ts` para incluir 'mercadopago'\r\n4. ✅ Actualizado el mapeo de métodos de pago en `usePayments.ts`\r\n5. ✅ Actualizado el mapeo de métodos de pago en `OwnerDashboard.tsx` para mostrar \"Mercado Pago\"\r\n6. ✅ Creada migración SQL en `infra/db/migrations/fix_payment_method_constraints.sql`\r\n\r\n## Próximos pasos\r\n\r\n1. Ejecutar la migración SQL en Supabase\r\n2. Crear un turno de prueba con método de pago \"Mercado Pago\"\r\n3. Completar el turno\r\n4. Verificar que se cree el pago automáticamente\r\n5. Verificar que el pago se refleje en Finanzas (Ingresos Totales)\r\n\r\n",
  "sections": []
}