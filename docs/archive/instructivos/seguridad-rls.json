{
  "metadata": {
    "title": "ğŸ”’ Seguridad RLS - Row Level Security",
    "path": "docs/archive/instructivos/seguridad-rls.md",
    "category": "instructivos",
    "tags": [
      "instructivos"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "seguridad-rls"
  },
  "content": "# ğŸ”’ Seguridad RLS - Row Level Security\r\n\r\nCOREBOARD implementa **Row Level Security (RLS)** enterprise-grade para aislamiento completo multi-tenant.\r\n\r\n## ğŸ¯ Principios de Seguridad\r\n\r\n### Aislamiento por OrganizaciÃ³n\r\n- Cada usuario ve **SOLO datos de sus organizaciones**\r\n- PolÃ­ticas RLS en **todas las tablas** crÃ­ticas\r\n- ValidaciÃ³n a nivel de base de datos (no solo UI)\r\n\r\n### Defense in Depth\r\n- âœ… RLS como primera lÃ­nea de defensa\r\n- âœ… ValidaciÃ³n en aplicaciÃ³n\r\n- âœ… AutenticaciÃ³n robusta\r\n- âœ… AuditorÃ­a completa\r\n\r\n## ğŸ—ï¸ Arquitectura RLS\r\n\r\n```\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚   auth.users    â”‚    â”‚ memberships     â”‚    â”‚   app.orgs      â”‚\r\nâ”‚   (Supabase)    â”‚â—„â”€â”€â–ºâ”‚ (userâ†”org)     â”‚â—„â”€â”€â–ºâ”‚   (tenants)      â”‚\r\nâ”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n        â”‚                       â”‚                       â”‚\r\n        â–¼                       â–¼                       â–¼\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚  RLS Policies   â”‚    â”‚  Helper Funcs   â”‚    â”‚  Role Checks    â”‚\r\nâ”‚  (tenant iso-   â”‚    â”‚  (user_is_      â”‚    â”‚  (owner/admin/   â”‚\r\nâ”‚   lation)       â”‚    â”‚   member_of)    â”‚    â”‚   employee)      â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n```\r\n\r\n## ğŸ“‹ PolÃ­ticas RLS por Tabla\r\n\r\n### ğŸ¢ Organizaciones (`app.organizations`)\r\n\r\n```sql\r\n-- Lectura: Solo miembros de la org\r\nCREATE POLICY \"orgs_read_members\" ON app.organizations\r\n  FOR SELECT USING (\r\n    id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n    AND deleted_at IS NULL\r\n  );\r\n\r\n-- Escritura: Solo owners pueden modificar\r\nCREATE POLICY \"orgs_write_owners\" ON app.organizations\r\n  FOR ALL USING (\r\n    id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role = 'owner'\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸ‘¥ MembresÃ­as (`app.memberships`)\r\n\r\n```sql\r\n-- Lectura: Solo las propias membresÃ­as\r\nCREATE POLICY \"memberships_read_own\" ON app.memberships\r\n  FOR SELECT USING (user_id = auth.uid());\r\n\r\n-- GestiÃ³n: Owners pueden invitar, admins pueden modificar\r\nCREATE POLICY \"memberships_manage_admins\" ON app.memberships\r\n  FOR ALL USING (\r\n    org_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸª Salones (`app.salons`)\r\n\r\n```sql\r\n-- Acceso completo para miembros de la org\r\nCREATE POLICY \"salons_org_access\" ON app.salons\r\n  FOR ALL USING (\r\n    org_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n    AND deleted_at IS NULL\r\n  );\r\n\r\n-- EliminaciÃ³n: Solo owners/admins\r\nCREATE POLICY \"salons_delete_restricted\" ON app.salons\r\n  FOR DELETE USING (\r\n    org_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n### âœ‚ï¸ Servicios (`app.services`)\r\n\r\n```sql\r\n-- Acceso completo para miembros de la org\r\nCREATE POLICY \"services_org_access\" ON app.services\r\n  FOR ALL USING (\r\n    org_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n    AND deleted_at IS NULL\r\n  );\r\n\r\n-- ModificaciÃ³n: Owners/admins\r\nCREATE POLICY \"services_modify_restricted\" ON app.services\r\n  FOR UPDATE USING (\r\n    org_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸ‘· Empleados (`app.employees`)\r\n\r\n```sql\r\n-- Lectura: Todos los miembros de la org ven empleados\r\nCREATE POLICY \"employees_org_read\" ON app.employees\r\n  FOR SELECT USING (\r\n    org_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n    AND deleted_at IS NULL  -- Solo activos\r\n    AND user_id IS NOT NULL  -- Regla de oro: debe tener user_id\r\n    AND active = true  -- Solo empleados activos\r\n  );\r\n\r\n-- GestiÃ³n: Solo owners/admins\r\nCREATE POLICY \"employees_manage_admins\" ON app.employees\r\n  FOR ALL USING (\r\n    org_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n    AND user_id IS NOT NULL  -- Regla de oro: no permitir sin user_id\r\n  );\r\n```\r\n\r\n### ğŸª Asignaciones SalÃ³n-Empleado (`public.salon_employees`)\r\n\r\n```sql\r\n-- Lectura: Miembros de la org del salÃ³n\r\nCREATE POLICY \"salon_employees_read\" ON public.salon_employees\r\n  FOR SELECT USING (\r\n    salon_id IN (\r\n      SELECT id FROM app.salons\r\n      WHERE org_id IN (\r\n        SELECT org_id FROM app.memberships\r\n        WHERE user_id = auth.uid()\r\n      )\r\n    )\r\n    AND active = true  -- Solo asignaciones activas\r\n  );\r\n\r\n-- GestiÃ³n: Solo owners/admins\r\nCREATE POLICY \"salon_employees_manage_admins\" ON public.salon_employees\r\n  FOR ALL USING (\r\n    salon_id IN (\r\n      SELECT id FROM app.salons\r\n      WHERE org_id IN (\r\n        SELECT org_id FROM app.memberships\r\n        WHERE user_id = auth.uid()\r\n          AND role IN ('owner', 'admin')\r\n      )\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸ‘¥ Clientes (`public.clients`)\r\n\r\n```sql\r\n-- Acceso completo para miembros de la org\r\nCREATE POLICY \"clients_org_access\" ON public.clients\r\n  FOR ALL USING (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n  );\r\n\r\n-- CreaciÃ³n: Cualquier miembro puede crear clientes\r\nCREATE POLICY \"clients_create_members\" ON public.clients\r\n  FOR INSERT WITH CHECK (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸ“… Turnos (`public.appointments`)\r\n\r\n```sql\r\n-- Lectura: Miembros de la org del salÃ³n\r\nCREATE POLICY \"appointments_org_read\" ON public.appointments\r\n  FOR SELECT USING (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n  );\r\n\r\n-- CreaciÃ³n: Cualquier miembro puede crear turnos\r\nCREATE POLICY \"appointments_create_members\" ON public.appointments\r\n  FOR INSERT WITH CHECK (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n    AND created_by = auth.uid()\r\n  );\r\n\r\n-- ModificaciÃ³n: Cualquier miembro puede modificar turnos de su org\r\nCREATE POLICY \"appointments_modify_members\" ON public.appointments\r\n  FOR UPDATE USING (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸ’° Pagos (`public.payments`)\r\n\r\n```sql\r\n-- Acceso completo para miembros de la org\r\nCREATE POLICY \"payments_org_access\" ON public.payments\r\n  FOR ALL USING (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n  );\r\n\r\n-- CreaciÃ³n: Solo owners/admins\r\nCREATE POLICY \"payments_create_restricted\" ON public.payments\r\n  FOR INSERT WITH CHECK (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸ’¸ Gastos (`public.expenses`)\r\n\r\n```sql\r\n-- Lectura: Todos los miembros ven gastos\r\nCREATE POLICY \"expenses_org_read\" ON public.expenses\r\n  FOR SELECT USING (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n  );\r\n\r\n-- CreaciÃ³n: Cualquier miembro puede registrar gastos\r\nCREATE POLICY \"expenses_create_members\" ON public.expenses\r\n  FOR INSERT WITH CHECK (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n    AND created_by = auth.uid()\r\n  );\r\n\r\n-- ModificaciÃ³n: Solo owners/admins\r\nCREATE POLICY \"expenses_modify_restricted\" ON public.expenses\r\n  FOR UPDATE USING (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n### ğŸ« Invitaciones (`public.invitations`)\r\n\r\n```sql\r\n-- NINGÃšN SELECT: Previene filtraciÃ³n de tokens\r\nCREATE POLICY \"invitations_no_select\" ON public.invitations\r\n  FOR SELECT USING (false);\r\n\r\n-- GestiÃ³n: Solo owners/admins de la org\r\nCREATE POLICY \"invitations_admin_manage\" ON public.invitations\r\n  FOR ALL USING (\r\n    organization_id IN (\r\n      SELECT org_id FROM app.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n## ğŸ”§ Funciones Helper\r\n\r\n### Verificar MembresÃ­a\r\n\r\n```sql\r\n-- FunciÃ³n para verificar si usuario es miembro de org\r\nCREATE OR REPLACE FUNCTION public.user_is_member_of(org_id uuid)\r\nRETURNS boolean\r\nLANGUAGE sql\r\nSECURITY DEFINER\r\nSET search_path = public, app\r\nAS $$\r\n  SELECT EXISTS (\r\n    SELECT 1 FROM app.memberships\r\n    WHERE user_id = auth.uid()\r\n      AND org_id = $1\r\n  );\r\n$$;\r\n\r\n-- FunciÃ³n para verificar rol especÃ­fico\r\nCREATE OR REPLACE FUNCTION public.user_has_role_in_org(org_id uuid, required_role text)\r\nRETURNS boolean\r\nLANGUAGE sql\r\nSECURITY DEFINER\r\nSET search_path = public, app\r\nAS $$\r\n  SELECT EXISTS (\r\n    SELECT 1 FROM app.memberships\r\n    WHERE user_id = auth.uid()\r\n      AND org_id = $1\r\n      AND role = $2\r\n  );\r\n$$;\r\n```\r\n\r\n### Uso en PolÃ­ticas\r\n\r\n```sql\r\n-- Ejemplo simplificado usando helper\r\nCREATE POLICY \"services_org_access\" ON app.services\r\n  FOR ALL USING (user_is_member_of(org_id));\r\n\r\nCREATE POLICY \"services_modify_admin\" ON app.services\r\n  FOR UPDATE USING (user_has_role_in_org(org_id, 'admin'));\r\n```\r\n\r\n## ğŸ­ Matriz de Permisos por Rol\r\n\r\n| Tabla/AcciÃ³n | owner | admin | employee | viewer |\r\n|--------------|-------|-------|----------|--------|\r\n| **Organizaciones** | âœ… CRUD | âŒ | âŒ | âŒ |\r\n| **MembresÃ­as** | âœ… CRUD | âœ… Invitar | âŒ | âŒ |\r\n| **Salones** | âœ… CRUD | âœ… CRUD | âœ… Ver | âœ… Ver |\r\n| **Servicios** | âœ… CRUD | âœ… CRUD | âœ… Ver | âœ… Ver |\r\n| **Empleados** | âœ… CRUD | âœ… CRUD | âœ… Ver | âœ… Ver |\r\n| **Clientes** | âœ… CRUD | âœ… CRUD | âœ… CRUD | âœ… Ver |\r\n| **Turnos** | âœ… CRUD | âœ… CRUD | âœ… CRUD | âœ… Ver |\r\n| **Pagos** | âœ… CRUD | âœ… CRUD | âŒ | âŒ |\r\n| **Gastos** | âœ… CRUD | âœ… CRUD | âœ… Crear | âœ… Ver |\r\n| **Invitaciones** | âœ… CRUD | âœ… CRUD | âŒ | âŒ |\r\n\r\n## ğŸ§ª Testing de Seguridad\r\n\r\n### Tests de Aislamiento\r\n\r\n```sql\r\n-- Test 1: Usuario A no ve datos de Usuario B\r\n-- (Ejecutar como usuario A)\r\nSELECT COUNT(*) FROM public.clients WHERE org_id NOT IN (\r\n  SELECT org_id FROM app.memberships WHERE user_id = auth.uid()\r\n);\r\n-- Debe retornar 0\r\n\r\n-- Test 2: Employee no puede crear pagos\r\n-- (Ejecutar como employee)\r\nINSERT INTO public.payments (org_id, appointment_id, amount, payment_method, date)\r\nVALUES ('org-id', NULL, 1000, 'cash', CURRENT_DATE);\r\n-- Debe fallar con RLS violation\r\n```\r\n\r\n### Bypass Prevention\r\n\r\n```sql\r\n-- Test 3: Verificar que no se puede acceder directamente\r\n-- Intentar SELECT sin WHERE org_id\r\nSELECT * FROM public.clients LIMIT 1;\r\n-- Debe retornar vacÃ­o o error\r\n\r\n-- Test 4: Verificar foreign keys protegidas\r\nINSERT INTO public.services (org_id, name, base_price)\r\nVALUES ('invalid-org-id', 'Test Service', 100);\r\n-- Debe fallar por RLS (no acceso a org invÃ¡lida)\r\n```\r\n\r\n## âš ï¸ Consideraciones CrÃ­ticas\r\n\r\n### Performance\r\n- âœ… Ãndices en `org_id` y `user_id`\r\n- âœ… Subqueries optimizadas\r\n- âœ… Cache de membresÃ­as en aplicaciÃ³n\r\n\r\n### AuditorÃ­a\r\n- âœ… Todas las operaciones logueadas\r\n- âœ… Triggers para cambios sensibles\r\n- âœ… Alertas en accesos no autorizados\r\n\r\n### Edge Cases\r\n- âœ… Usuarios sin membresÃ­as (bloqueados)\r\n- âœ… Ã“rganos sin miembros (permitido para setup)\r\n- âœ… Transferencia de ownership\r\n- âœ… EliminaciÃ³n en cascada\r\n\r\n### Mantenimiento\r\n```sql\r\n-- Verificar polÃ­ticas activas\r\nSELECT schemaname, tablename, policyname, permissive, roles, cmd\r\nFROM pg_policies\r\nWHERE schemaname = 'public'\r\nORDER BY tablename, policyname;\r\n\r\n-- Desactivar RLS temporalmente (SOLO para mantenimiento)\r\nALTER TABLE public.clients DISABLE ROW LEVEL SECURITY;\r\n-- ... hacer mantenimiento ...\r\nALTER TABLE public.clients ENABLE ROW LEVEL SECURITY;\r\n```\r\n\r\n## ğŸš¨ Respuesta a Incidentes\r\n\r\n### ViolaciÃ³n de RLS Detectada\r\n1. **Inmediato**: Desactivar usuario sospechoso\r\n2. **AuditorÃ­a**: Revisar logs de acceso\r\n3. **MitigaciÃ³n**: Actualizar polÃ­ticas si hay brecha\r\n4. **PrevenciÃ³n**: AÃ±adir validaciones adicionales\r\n\r\n### RecuperaciÃ³n\r\n```sql\r\n-- Reset permisos si hay problema\r\nDROP POLICY IF EXISTS \"problematic_policy\" ON public.table_name;\r\nCREATE POLICY \"fixed_policy\" ON public.table_name ...;\r\n\r\n-- Reindexar si hay performance issues\r\nREINDEX INDEX CONCURRENTLY idx_table_org_id;\r\n```\r\n\r\n## ğŸ“Š Monitoreo\r\n\r\n### Queries de Monitoreo\r\n```sql\r\n-- PolÃ­ticas por tabla\r\nSELECT tablename, COUNT(*) as policies_count\r\nFROM pg_policies\r\nWHERE schemaname = 'public'\r\nGROUP BY tablename\r\nORDER BY tablename;\r\n\r\n-- RLS violations (si se loguean)\r\nSELECT * FROM audit_logs\r\nWHERE action = 'RLS_VIOLATION'\r\nORDER BY created_at DESC LIMIT 100;\r\n\r\n-- Usuarios sin membresÃ­as (potencial problema)\r\nSELECT u.email, u.created_at\r\nFROM auth.users u\r\nLEFT JOIN app.memberships m ON u.id = m.user_id\r\nWHERE m.id IS NULL\r\n  AND u.created_at < now() - interval '1 hour';\r\n\r\n-- Empleados sin user_id (violaciÃ³n de regla de oro)\r\nSELECT e.id, e.full_name, e.email, o.name as org_name\r\nFROM app.employees e\r\nJOIN app.organizations o ON e.org_id = o.id\r\nWHERE e.user_id IS NULL\r\n  AND e.deleted_at IS NULL\r\nORDER BY o.name, e.full_name;\r\n```\r\n\r\n**VersiÃ³n:** 2.0.0\r\n**Ãšltima actualizaciÃ³n:** Noviembre 2025\r\n\r\n## ğŸ“‹ Cambios Recientes (v2.0.0)\r\n\r\n### Validaciones de Empleados en RLS\r\n- âœ… **Regla de oro**: PolÃ­ticas RLS verifican `user_id IS NOT NULL`\r\n- âœ… **Tabla `salon_employees`**: PolÃ­ticas RLS para asignaciones\r\n- âœ… **ValidaciÃ³n en triggers**: `validate_appointment()` valida asignaciÃ³n antes de insertar turno\r\n",
  "sections": []
}