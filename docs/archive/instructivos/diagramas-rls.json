{
  "metadata": {
    "title": "üìä Diagramas RLS - Arquitectura de Seguridad",
    "path": "docs/archive/instructivos/diagramas-rls.md",
    "category": "instructivos",
    "tags": [
      "instructivos"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "diagramas-rls"
  },
  "content": "# üìä Diagramas RLS - Arquitectura de Seguridad\r\n\r\nDiagramas visuales de las pol√≠ticas Row Level Security y arquitectura multi-tenant de COREBOARD.\r\n\r\n## üèõÔ∏è Arquitectura Multi-Tenant\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Supabase PostgreSQL\"\r\n        subgraph \"Auth Schema\"\r\n            AU[auth.users<br/>- id<br/>- email<br/>- encrypted_password]\r\n        end\r\n\r\n        subgraph \"App Schema\"\r\n            ORG[app.orgs<br/>- id<br/>- name<br/>- settings]\r\n        end\r\n\r\n        subgraph \"Public Schema\"\r\n            MEM[app.memberships<br/>- user_id ‚Üí auth.users<br/>- org_id ‚Üí app.orgs<br/>- role]\r\n            SAL[app.salons<br/>- org_id<br/>- name<br/>- address<br/>- staff: string[] ELIMINADO]\r\n            EMP[app.employees<br/>- org_id<br/>- user_id OBLIGATORIO<br/>- full_name<br/>- active]\r\n            SEM[salon_employees<br/>- salon_id<br/>- employee_id<br/>- active<br/>many-to-many]\r\n            APT[public.appointments<br/>- org_id<br/>- salon_id<br/>- employee_id<br/>- client_id]\r\n            CLI[public.clients<br/>- org_id<br/>- name<br/>- phone]\r\n            SRV[app.services<br/>- org_id<br/>- name<br/>- price]\r\n            PAY[public.payments<br/>- org_id<br/>- amount<br/>- method]\r\n        end\r\n    end\r\n\r\n    subgraph \"Application Layer\"\r\n        AUTH[Authentication<br/>Supabase Auth]\r\n        RLS[Row Level Security<br/>PostgreSQL Policies]\r\n        APP[Next.js App<br/>React Components]\r\n    end\r\n\r\n    AUTH --> AU\r\n    APP --> RLS\r\n    RLS --> MEM\r\n    RLS --> SAL\r\n    RLS --> EMP\r\n    RLS --> SEM\r\n    RLS --> APT\r\n    RLS --> CLI\r\n    RLS --> SRV\r\n    RLS --> PAY\r\n```\r\n\r\n## üîê Flujo de Seguridad por Request\r\n\r\n```mermaid\r\nsequenceDiagram\r\n    participant U as Usuario\r\n    participant A as Next.js App\r\n    participant S as Supabase\r\n    participant P as PostgreSQL RLS\r\n\r\n    U->>A: Request (ej: GET /appointments)\r\n    A->>A: Validar sesi√≥n JWT\r\n    A->>S: Query con JWT token\r\n    S->>P: Ejecutar query + pol√≠ticas RLS\r\n    P->>P: Filtrar por org_id del usuario\r\n    P->>S: Resultados filtrados\r\n    S->>A: Response seguro\r\n    A->>U: Data solo de su org\r\n\r\n    Note over P: SELECT * FROM appointments<br/>WHERE org_id IN (<br/>  SELECT org_id FROM memberships<br/>  WHERE user_id = auth.uid()<br/>)\r\n```\r\n\r\n## üë• Matriz de Permisos por Rol\r\n\r\n```mermaid\r\ngraph TD\r\n    subgraph \"Roles del Sistema\"\r\n        OWNER[üëë Owner<br/>Propietario]\r\n        ADMIN[‚ö° Admin<br/>Administrador]\r\n        EMPLOYEE[üë∑ Employee<br/>Empleado]\r\n        VIEWER[üëÅÔ∏è Viewer<br/>Solo lectura]\r\n    end\r\n\r\n    subgraph \"Permisos por Tabla\"\r\n        ORG_PERMS[üè¢ Organizaciones<br/>OWNER: CRUD<br/>ADMIN: ‚ùå<br/>EMPLOYEE: ‚ùå<br/>VIEWER: ‚ùå]\r\n\r\n        MEMBERS_PERMS[üë• Membres√≠as<br/>OWNER: CRUD<br/>ADMIN: Invitar<br/>EMPLOYEE: ‚ùå<br/>VIEWER: ‚ùå]\r\n\r\n        SALONS_PERMS[üè™ Salones<br/>OWNER: CRUD<br/>ADMIN: CRUD<br/>EMPLOYEE: Ver<br/>VIEWER: Ver]\r\n\r\n        APPTS_PERMS[üìÖ Turnos<br/>OWNER: CRUD<br/>ADMIN: CRUD<br/>EMPLOYEE: CRUD<br/>VIEWER: Ver]\r\n\r\n        CLIENTS_PERMS[üë§ Clientes<br/>OWNER: CRUD<br/>ADMIN: CRUD<br/>EMPLOYEE: CRUD<br/>VIEWER: Ver]\r\n\r\n        SERVICES_PERMS[‚úÇÔ∏è Servicios<br/>OWNER: CRUD<br/>ADMIN: CRUD<br/>EMPLOYEE: Ver<br/>VIEWER: Ver]\r\n\r\n        PAYMENTS_PERMS[üí∞ Pagos<br/>OWNER: CRUD<br/>ADMIN: CRUD<br/>EMPLOYEE: ‚ùå<br/>VIEWER: ‚ùå]\r\n    end\r\n\r\n    OWNER --> ORG_PERMS\r\n    ADMIN --> MEMBERS_PERMS\r\n    EMPLOYEE --> SALONS_PERMS\r\n    VIEWER --> APPTS_PERMS\r\n```\r\n\r\n## üõ°Ô∏è Pol√≠ticas RLS Detalladas\r\n\r\n### Organizaciones (`app.orgs`)\r\n\r\n```sql\r\n-- Pol√≠tica de lectura\r\nCREATE POLICY \"orgs_read_members\" ON app.orgs\r\n  FOR SELECT USING (\r\n    id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n    )\r\n  );\r\n\r\n-- Pol√≠tica de escritura (solo owners)\r\nCREATE POLICY \"orgs_write_owners\" ON app.orgs\r\n  FOR ALL USING (\r\n    id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role = 'owner'\r\n    )\r\n  );\r\n```\r\n\r\n**Diagrama visual:**\r\n```mermaid\r\ngraph LR\r\n    A[Usuario] --> B{¬øEs miembro<br/>de la org?}\r\n    B -->|S√≠| C[‚úÖ Puede leer]\r\n    B -->|No| D[‚ùå Denegado]\r\n\r\n    A --> E{¬øEs owner<br/>de la org?}\r\n    E -->|S√≠| F[‚úÖ Puede modificar]\r\n    E -->|No| G[‚ùå Denegado]\r\n```\r\n\r\n### Membres√≠as (`public.memberships`)\r\n\r\n```sql\r\n-- Lectura propia\r\nCREATE POLICY \"memberships_read_own\" ON public.memberships\r\n  FOR SELECT USING (user_id = auth.uid());\r\n\r\n-- Gesti√≥n (owners/admins)\r\nCREATE POLICY \"memberships_manage_admins\" ON public.memberships\r\n  FOR ALL USING (\r\n    org_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n**Flujo de permisos:**\r\n```mermaid\r\ngraph TD\r\n    A[Usuario quiere acceder<br/>a membres√≠as] --> B{¬øEs su propia<br/>membres√≠a?}\r\n    B -->|S√≠| C[‚úÖ Puede leer]\r\n    B -->|No| D{¬øEs owner/admin<br/>de la org?}\r\n    D -->|S√≠| E[‚úÖ Puede gestionar<br/>todas las membres√≠as]\r\n    D -->|No| F[‚ùå Denegado]\r\n```\r\n\r\n### Invitaciones (`public.invitations`)\r\n\r\n```sql\r\n-- NO SELECT (seguridad m√°xima)\r\nCREATE POLICY \"invitations_no_select\" ON public.invitations\r\n  FOR SELECT USING (false);\r\n\r\n-- Gesti√≥n restringida\r\nCREATE POLICY \"invitations_admin_manage\" ON public.invitations\r\n  FOR ALL USING (\r\n    organization_id IN (\r\n      SELECT org_id FROM public.memberships\r\n      WHERE user_id = auth.uid()\r\n        AND role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n**Modelo de seguridad:**\r\n```mermaid\r\ngraph TD\r\n    A[Usuario] --> B{¬øIntenta leer<br/>invitaciones?}\r\n    B --> C[‚ùå SIEMPRE DENEGADO<br/>Previene leaks de tokens]\r\n\r\n    A --> D{¬øEs owner/admin<br/>y quiere gestionar?}\r\n    D -->|S√≠| E[‚úÖ Puede crear/modificar<br/>invitaciones de su org]\r\n    D -->|No| F[‚ùå Denegado]\r\n```\r\n\r\n## üîÑ Flujo de Invitaci√≥n Seguro\r\n\r\n```mermaid\r\nsequenceDiagram\r\n    participant O as Owner/Admin\r\n    participant S as Sistema\r\n    participant DB as Base de Datos\r\n    participant U as Usuario Invitado\r\n\r\n    O->>S: Generar invitaci√≥n\r\n    S->>DB: INSERT invitaci√≥n con token_hash\r\n    DB->>S: invitaci√≥n_id\r\n    S->>O: Token plano (solo mostrar una vez)\r\n\r\n    O->>U: Compartir token por email/chat\r\n    U->>S: Registrarse con token\r\n    S->>DB: signUp + claim_invitation(token)\r\n    DB->>DB: Validar token_hash + crear membres√≠a\r\n    DB->>S: Success + org_id + role\r\n    S->>U: ‚úÖ Acceso concedido\r\n```\r\n\r\n## üè¢ Aislamiento Multi-Tenant\r\n\r\n### Arquitectura por Organizaci√≥n\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Organizaci√≥n A (org_a)\"\r\n        UA[Usuario A1<br/>role: owner]\r\n        UA2[Usuario A2<br/>role: employee]\r\n        SA[Sal√≥n A1]\r\n        AA[Turnos A]\r\n        CA[Clientes A]\r\n        PA[Pagos A]\r\n    end\r\n\r\n    subgraph \"Organizaci√≥n B (org_b)\"\r\n        UB[Usuario B1<br/>role: owner]\r\n        UB2[Usuario B2<br/>role: admin]\r\n        SB[Sal√≥n B1]\r\n        AB[Turnos B]\r\n        CB[Clientes B]\r\n        PB[Pagos B]\r\n    end\r\n\r\n    subgraph \"RLS Engine\"\r\n        RLS[Row Level Security<br/>PostgreSQL Policies]\r\n    end\r\n\r\n    UA --> RLS\r\n    UA2 --> RLS\r\n    UB --> RLS\r\n    UB2 --> RLS\r\n\r\n    RLS --> SA\r\n    RLS --> AA\r\n    RLS --> CA\r\n    RLS --> PA\r\n\r\n    RLS --> SB\r\n    RLS --> AB\r\n    RLS --> CB\r\n    RLS --> PB\r\n\r\n    Note over RLS: Filtro autom√°tico<br/>por org_id del usuario\r\n```\r\n\r\n### Ejemplo de Query con RLS\r\n\r\n```sql\r\n-- Query original del usuario\r\nSELECT * FROM appointments;\r\n\r\n-- Lo que RLS ejecuta internamente\r\nSELECT * FROM appointments\r\nWHERE org_id IN (\r\n  SELECT org_id FROM memberships\r\n  WHERE user_id = auth.uid()\r\n);\r\n\r\n-- Resultado: Solo turnos de las orgs del usuario\r\n```\r\n\r\n## ‚ö†Ô∏è Casos de Error y Mitigaci√≥n\r\n\r\n### 1. Acceso no Autorizado\r\n\r\n```mermaid\r\ngraph TD\r\n    A[Usuario B intenta<br/>acceder datos de Org A] --> B{RLS Policy<br/>org_id check}\r\n    B -->|FAIL| C[‚ùå Query retorna vac√≠o]\r\n    B --> D[Log de auditor√≠a<br/>acceso denegado]\r\n```\r\n\r\n### 2. Token de Invitaci√≥n Expirado\r\n\r\n```mermaid\r\ngraph TD\r\n    A[Usuario reclama<br/>token expirado] --> B{claim_invitation()<br/>validaci√≥n}\r\n    B -->|now() > expires_at| C[‚ùå Error: token expirado]\r\n    B --> D[Log de intento<br/>fallido]\r\n```\r\n\r\n### 3. Token Ya Usado\r\n\r\n```mermaid\r\ngraph TD\r\n    A[Usuario reclama<br/>token usado] --> B{claim_invitation()<br/>FOR UPDATE check}\r\n    B -->|used_at IS NOT NULL| C[‚ùå Error: token ya usado]\r\n    B --> D[Log de intento<br/>duplicado]\r\n```\r\n\r\n## üìä Monitoreo de Seguridad\r\n\r\n### Dashboard de Seguridad\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"M√©tricas de Seguridad\"\r\n        AUTH[Autenticaciones<br/>por hora/d√≠a]\r\n        RLS_V[Violaciones RLS<br/>detectadas]\r\n        INV_U[Invitaciones<br/>usadas/expiradas]\r\n        SESS[Sesiones activas<br/>por usuario]\r\n    end\r\n\r\n    subgraph \"Alertas\"\r\n        BRUTE[Intentos de<br/>fuerza bruta]\r\n        UN_AUTH[Accesos no<br/>autorizados]\r\n        INV_EXP[Invitaciones<br/>expiradas]\r\n        SESS_LONG[Sesiones<br/>muy largas]\r\n    end\r\n\r\n    subgraph \"Logs\"\r\n        AUDIT[Auditor√≠a completa<br/>de acciones]\r\n        ERR[Errores de<br/>seguridad]\r\n        PERF[Performance<br/>de queries]\r\n    end\r\n\r\n    AUTH --> BRUTE\r\n    RLS_V --> UN_AUTH\r\n    INV_U --> INV_EXP\r\n    SESS --> SESS_LONG\r\n\r\n    BRUTE --> AUDIT\r\n    UN_AUTH --> AUDIT\r\n    INV_EXP --> AUDIT\r\n    SESS_LONG --> AUDIT\r\n```\r\n\r\n### Queries de Monitoreo\r\n\r\n```sql\r\n-- Violaciones RLS por usuario\r\nSELECT\r\n  u.email,\r\n  COUNT(*) as violations,\r\n  MAX(created_at) as last_violation\r\nFROM audit_logs a\r\nJOIN auth.users u ON a.user_id = u.id\r\nWHERE a.action = 'RLS_VIOLATION'\r\n  AND a.created_at > now() - interval '7 days'\r\nGROUP BY u.id, u.email\r\nORDER BY violations DESC;\r\n\r\n-- Invitaciones pendientes\r\nSELECT\r\n  i.email,\r\n  i.role,\r\n  o.name as org_name,\r\n  i.created_at,\r\n  i.expires_at,\r\n  EXTRACT(EPOCH FROM (i.expires_at - now())) / 86400 as days_left\r\nFROM public.invitations i\r\nJOIN app.orgs o ON i.organization_id = o.id\r\nWHERE i.used_at IS NULL\r\nORDER BY i.expires_at ASC;\r\n```\r\n\r\n## üõ†Ô∏è Testing de Seguridad\r\n\r\n### Suite de Tests de Penetraci√≥n\r\n\r\n```typescript\r\ndescribe('Security Tests', () => {\r\n  test('RLS prevents cross-tenant access', async () => {\r\n    // Usuario A intenta acceder datos de Usuario B\r\n    const userA = await login('userA@orgA.com')\r\n    const result = await query('SELECT * FROM appointments WHERE org_id = ?', ['org-b-id'])\r\n    expect(result.length).toBe(0) // Debe estar vac√≠o\r\n  })\r\n\r\n  test('Invitation tokens are single-use', async () => {\r\n    const token = await generateInvitation('employee', 'org-123')\r\n\r\n    // Primer uso\r\n    await claimInvitation(token)\r\n    expect(success).toBe(true)\r\n\r\n    // Segundo uso debe fallar\r\n    await expect(claimInvitation(token)).rejects.toThrow('token ya usado')\r\n  })\r\n\r\n  test('Role-based access control', async () => {\r\n    const employee = await login('employee@org.com')\r\n    await expect(createPayment(employee)).rejects.toThrow('RLS violation')\r\n  })\r\n})\r\n```\r\n\r\n## üîß Configuraci√≥n de Producci√≥n\r\n\r\n### Variables de Seguridad\r\n```bash\r\n# JWT Configuration\r\nSUPABASE_JWT_SECRET=your_jwt_secret\r\nSUPABASE_JWT_EXPIRY=3600\r\n\r\n# RLS Enable\r\nSUPABASE_ENABLE_RLS=true\r\n\r\n# Audit Logging\r\nSUPABASE_ENABLE_AUDIT=true\r\nSUPABASE_AUDIT_RETENTION_DAYS=90\r\n```\r\n\r\n### Backup de Pol√≠ticas\r\n```sql\r\n-- Backup de todas las pol√≠ticas RLS\r\nCREATE TABLE IF NOT EXISTS security_backup (\r\n  id serial PRIMARY KEY,\r\n  backup_date timestamptz DEFAULT now(),\r\n  policies jsonb\r\n);\r\n\r\nINSERT INTO security_backup (policies)\r\nSELECT jsonb_agg(\r\n  jsonb_build_object(\r\n    'schema', schemaname,\r\n    'table', tablename,\r\n    'policy', policyname,\r\n    'definition', pg_get_policydef(p.oid)\r\n  )\r\n)\r\nFROM pg_policies p\r\nWHERE schemaname IN ('public', 'app');\r\n```\r\n\r\n---\r\n\r\n**Diagrama generado con Mermaid**\r\n**√öltima actualizaci√≥n:** Noviembre 2025\r\n\r\n## üìã Cambios Recientes (v2.0.0)\r\n\r\n### Actualizaciones en Diagramas\r\n- ‚úÖ **Tabla `salon_employees`**: Agregada en diagramas de arquitectura\r\n- ‚úÖ **Regla de oro**: Empleados requieren `user_id` (documentado en flujos)\r\n- ‚úÖ **Validaciones**: Diagramas de flujo incluyen validaci√≥n de asignaci√≥n empleado-sal√≥n\r\n",
  "sections": []
}