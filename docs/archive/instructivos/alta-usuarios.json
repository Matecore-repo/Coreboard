{
  "metadata": {
    "title": "üë• Alta de Usuarios - Sistema de Invitaciones",
    "path": "docs/archive/instructivos/alta-usuarios.md",
    "category": "instructivos",
    "tags": [
      "instructivos"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "alta-usuarios"
  },
  "content": "# üë• Alta de Usuarios - Sistema de Invitaciones\r\n\r\nCOREBOARD utiliza un sistema seguro de invitaciones con tokens de un solo uso para controlar el acceso a organizaciones.\r\n\r\n## üîê Arquitectura de Seguridad\r\n\r\n### Tokens Hashed (SHA-256)\r\n- Los tokens **NO se guardan en texto plano** en la base de datos\r\n- Se almacenan como hash SHA-256 para prevenir filtraciones\r\n- El token real se muestra solo al administrador que lo genera\r\n\r\n### Un Solo Uso\r\n- Cada token puede ser usado exactamente **una vez**\r\n- Se marca como `used_at` al ser reclamado\r\n- Validaci√≥n at√≥mica con `FOR UPDATE` (previene race conditions)\r\n\r\n### Expiraci√≥n Autom√°tica\r\n- Tokens expiran autom√°ticamente (default: 7 d√≠as)\r\n- Configurable por invitaci√≥n\r\n- Validaci√≥n en tiempo real\r\n\r\n## üéØ Roles del Sistema\r\n\r\n| Rol | Descripci√≥n | Permisos UI | Permisos BD |\r\n|-----|-------------|-------------|-------------|\r\n| `admin` | Administrador de plataforma | ‚úÖ **Todo el sistema** | ‚úÖ **Super admin** |\r\n| `owner` | Propietario de sal√≥n | ‚úÖ Todo su sal√≥n | ‚úÖ Full access a su org |\r\n| `employee` | Empleado de sal√≥n | ‚úÖ Solo: Inicio, Turnos, Clientes | ‚úÖ Lectura + turnos |\r\n| `viewer` | Solo lectura | ‚úÖ Solo ver datos | ‚úÖ Solo SELECT |\r\n\r\n## üë∑ Regla de Oro: Empleados\r\n\r\n**Empleado = Usuario autenticado dentro de una organizaci√≥n.**\r\n\r\n- No existe \"empleado sin usuario\". Si no tiene `user_id`, no es empleado.\r\n- `user_id` es obligatorio en tabla `app.employees`.\r\n- Empleados se asignan a salones mediante tabla `salon_employees` (many-to-many).\r\n- Validaci√≥n antes de crear turno: empleado debe estar asignado activamente al sal√≥n.\r\n\r\n## üöÄ Flujo de Invitaci√≥n\r\n\r\n### 1. Generaci√≥n de Token (Admin)\r\n\r\n```bash\r\n# Sintaxis del comando\r\nnode scripts/create_invitation.js <rol> <org_id> [email] [dias=7]\r\n\r\n# Ejemplos\r\nnode scripts/create_invitation.js owner abc123 owner@empresa.com\r\nnode scripts/create_invitation.js employee abc123 empleado@empresa.com\r\nnode scripts/create_invitation.js admin abc123 30  # 30 d√≠as v√°lido\r\n```\r\n\r\n**Output del comando:**\r\n```\r\n‚úÖ Invitaci√≥n creada\r\nID: 123e4567-e89b-12d3-a456-426614174000\r\nOrg: abc123-def456-ghi789\r\nEmail: owner@empresa.com\r\nRole: owner\r\nExpira: 2025-11-03T18:52:30.000Z\r\n---\r\nüîë TOKEN (compartilo con la persona invitada):\r\naB3dE5fG7hI9jK1lM3nO5pQ7rS9tU1vW3xY5zA7bC9dE\r\n---\r\n‚ö†Ô∏è Guard√° este token. No se puede recuperar desde la base.\r\n```\r\n\r\n### 2. Compartir Token\r\n- El admin comparte el **token plano** con el invitado\r\n- El invitado lo usa durante el registro\r\n- El token se invalida autom√°ticamente despu√©s del uso\r\n\r\n### 3. Registro del Invitado\r\n\r\n```typescript\r\n// En AuthContext.tsx - signUp con token\r\nconst { data, error } = await supabase.auth.signUp({\r\n  email,\r\n  password,\r\n  options: {\r\n    data: { invite_token: token } // Token incluido en metadata\r\n  }\r\n});\r\n```\r\n\r\n### 4. Reclamo Autom√°tico (RPC)\r\n\r\nAl completar el registro, se ejecuta autom√°ticamente:\r\n\r\n```sql\r\n-- Funci√≥n claim_invitation (RPC)\r\nSELECT claim_invitation('aB3dE5fG7hI9jK1lM3nO5pQ7rS9tU1vW3xY5zA7bC9dE')\r\n-- Retorna: { organization_id, role }\r\n```\r\n\r\n**Validaciones del RPC:**\r\n- ‚úÖ Token existe y no est√° usado\r\n- ‚úÖ Token no ha expirado\r\n- ‚úÖ Email coincide (si est√° restringido)\r\n- ‚úÖ Usuario autenticado\r\n\r\n## üóÑÔ∏è Estructura de Base de Datos\r\n\r\n### Tabla `invitations`\r\n\r\n```sql\r\nCREATE TABLE public.invitations (\r\n  id               uuid PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  organization_id  uuid REFERENCES app.organizations(id), -- NULL para admin (no pertenece a org espec√≠fica),\r\n  email            text, -- Opcional: restringe a email espec√≠fico\r\n  role             text NOT NULL CHECK (role IN ('admin','owner','employee')),\r\n  token_hash       bytea NOT NULL, -- SHA-256 del token\r\n  expires_at       timestamptz NOT NULL DEFAULT (now() + interval '7 days'),\r\n  used_at          timestamptz, -- NULL = disponible, NOT NULL = usado\r\n  used_by          uuid REFERENCES auth.users(id),\r\n  created_by       uuid REFERENCES auth.users(id),\r\n  created_at       timestamptz NOT NULL DEFAULT now()\r\n);\r\n\r\n-- √çndices cr√≠ticos\r\nCREATE UNIQUE INDEX invitations_token_unique_open\r\n  ON public.invitations(token_hash) WHERE used_at IS NULL;\r\n```\r\n\r\n### Tabla `memberships`\r\n\r\n```sql\r\nCREATE TABLE app.memberships (\r\n  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  org_id          uuid NOT NULL REFERENCES app.organizations(id) ON DELETE CASCADE,\r\n  user_id         uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\r\n  role            text NOT NULL CHECK (role IN ('admin','owner','employee','viewer')),\r\n  is_primary      boolean DEFAULT false,\r\n  created_at      timestamptz DEFAULT now(),\r\n  UNIQUE(org_id, user_id) -- Un usuario por org\r\n);\r\n```\r\n\r\n## üîí Pol√≠ticas RLS\r\n\r\n### Invitaciones (Restringidas)\r\n```sql\r\n-- Nadie puede leer tokens (previene filtraciones)\r\nCREATE POLICY \"inv_no_select\" ON public.invitations FOR SELECT USING (false);\r\n\r\n-- Solo owners/admins pueden gestionar invitaciones de su org\r\nCREATE POLICY \"inv_admin_manage\" ON public.invitations\r\n  USING (\r\n    EXISTS (\r\n      SELECT 1 FROM app.memberships m\r\n      WHERE m.org_id = invitations.organization_id\r\n        AND m.user_id = auth.uid()\r\n        AND m.role IN ('owner', 'admin')\r\n    )\r\n  );\r\n```\r\n\r\n### Membres√≠as (Por Usuario)\r\n```sql\r\n-- Cada usuario ve solo sus propias membres√≠as\r\nCREATE POLICY \"memberships_read_own\" ON app.memberships\r\n  FOR SELECT USING (user_id = auth.uid());\r\n```\r\n\r\n## üõ†Ô∏è Scripts de Administraci√≥n\r\n\r\n### Generar Invitaci√≥n\r\n```javascript\r\n// scripts/create_invitation.js\r\n// Requiere: SUPABASE_URL, SUPABASE_SERVICE_KEY\r\n\r\nconst token = crypto.randomBytes(32).toString('base64url');\r\nconst token_hash = crypto.createHash('sha256').update(token).digest();\r\n\r\nawait supabase.from('invitations').insert({\r\n  organization_id,\r\n  role,\r\n  token_hash,\r\n  email: emailArg || null,\r\n  expires_at: new Date(Date.now() + days * 24 * 60 * 60 * 1000)\r\n});\r\n```\r\n\r\n### Verificar Estado\r\n```sql\r\n-- Invitaciones activas\r\nSELECT id, email, role, expires_at, used_at\r\nFROM public.invitations\r\nWHERE used_at IS NULL\r\n  AND now() < expires_at;\r\n\r\n-- Membres√≠as por organizaci√≥n\r\nSELECT u.email, m.role, m.is_primary\r\nFROM app.memberships m\r\nJOIN auth.users u ON m.user_id = u.id\r\nWHERE m.org_id = 'your-org-id';\r\n```\r\n\r\n## ‚ö†Ô∏è Consideraciones de Seguridad\r\n\r\n### Ataques Mitigados\r\n- **Token Leakage**: Hashing previene exposici√≥n en dumps de BD\r\n- **Replay Attacks**: Un solo uso + expiraci√≥n autom√°tica\r\n- **Race Conditions**: `FOR UPDATE` en validaci√≥n at√≥mica\r\n- **Email Spoofing**: Validaci√≥n de email si est√° restringido\r\n\r\n### Mejores Pr√°cticas\r\n- ‚úÖ Usar HTTPS siempre\r\n- ‚úÖ Service key solo en servidor (nunca en cliente)\r\n- ‚úÖ Tokens con entrop√≠a alta (32 bytes)\r\n- ‚úÖ Expiraci√≥n corta (7 d√≠as max)\r\n- ‚úÖ Logs de auditor√≠a en producci√≥n\r\n\r\n## üß™ Testing\r\n\r\n### Flujo Completo de Testing\r\n\r\n1. **Crear organizaci√≥n**\r\n```sql\r\nINSERT INTO app.organizations (name) VALUES ('Test Corp') RETURNING id;\r\n-- Result: abc123-def456-ghi789\r\n```\r\n\r\n2. **Generar invitaci√≥n**\r\n```bash\r\nnode scripts/create_invitation.js owner abc123-def456-ghi789 test@example.com\r\n# Output: üîë TOKEN: aB3dE5fG7hI9jK1lM3nO5pQ7rS9tU1vW3xY5zA7bC9dE\r\n```\r\n\r\n3. **Registrar usuario con token**\r\n```typescript\r\nawait signUp('test@example.com', 'password123', 'aB3dE5fG7hI9jK1lM3nO5pQ7rS9tU1vW3xY5zA7bC9dE');\r\n```\r\n\r\n4. **Verificar membres√≠a creada**\r\n```sql\r\nSELECT * FROM app.memberships WHERE user_id IN (\r\n  SELECT id FROM auth.users WHERE email = 'test@example.com'\r\n);\r\n-- Debe retornar: role='owner', org_id='abc123...'\r\n```\r\n\r\n### Casos de Error\r\n- ‚ùå **Token expirado**: `claim_invitation` retorna error\r\n- ‚ùå **Token usado**: `claim_invitation` retorna error\r\n- ‚ùå **Email mismatch**: `claim_invitation` retorna error\r\n- ‚ùå **Usuario no autenticado**: `claim_invitation` retorna error\r\n\r\n## üìà Monitoreo y Auditor√≠a\r\n\r\n### M√©tricas a Monitorear\r\n- Invitaciones creadas vs usadas\r\n- Tasa de expiraci√≥n de tokens\r\n- Errores en claim_invitation\r\n- Usuarios por organizaci√≥n\r\n\r\n### Logs de Auditor√≠a\r\n```sql\r\n-- Invitaciones reclamadas recientemente\r\nSELECT i.email, i.role, i.used_at, u.email as claimed_by\r\nFROM public.invitations i\r\nJOIN auth.users u ON i.used_by = u.id\r\nWHERE i.used_at > now() - interval '24 hours'\r\nORDER BY i.used_at DESC;\r\n```\r\n\r\n## üìã Cambios Recientes (v2.0.0)\r\n\r\n### Regla de Oro: Empleados\r\n- ‚úÖ **user_id obligatorio**: No existe empleado sin usuario autenticado\r\n- ‚úÖ **Validaci√≥n en BD**: Constraint `employees_user_id_required`\r\n- ‚úÖ **Validaci√≥n en Frontend**: `employeeValidator.ts` filtra empleados sin user_id\r\n- ‚úÖ **Asignaciones**: Tabla `salon_employees` para asignar empleados a salones\r\n\r\n**Versi√≥n:** 2.0.0\r\n**√öltima actualizaci√≥n:** Noviembre 2025\r\n",
  "sections": []
}