{
  "metadata": {
    "title": "Soluciones Aplicadas - Pagos y Comisiones",
    "path": "docs/SOLUCIONES_APLICADAS.md",
    "category": "technical",
    "tags": [
      "technical"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "SOLUCIONES_APLICADAS"
  },
  "content": "# Soluciones Aplicadas - Pagos y Comisiones\r\n\r\n## ‚úÖ Problemas Identificados y Solucionados\r\n\r\n### 1. **Trigger de Comisiones** ‚úÖ SOLUCIONADO\r\n**Problema**: El trigger `generate_commission_on_complete` usaba campos incorrectos:\r\n- Usaba `stylist_id` (no existe) ‚Üí Corregido a `employee_id`\r\n- Usaba `commission_pct` (no existe) ‚Üí Corregido a `pct`\r\n- No inclu√≠a `appointment_item_id` (requerido) ‚Üí Agregado con creaci√≥n autom√°tica\r\n\r\n**Soluci√≥n**: \r\n- Migraci√≥n `fix_commission_trigger_corrected`: Corrige campos\r\n- Migraci√≥n `fix_commission_trigger_create_item`: Crea `appointment_item` autom√°ticamente si no existe\r\n\r\n### 2. **Trigger de Pagos** ‚úÖ SOLUCIONADO\r\n**Problema**: El trigger `generate_payment_on_complete` usaba campos incorrectos:\r\n- Usaba `payment_method` (text) ‚Üí Corregido a `method` (enum)\r\n- Usaba `processed_at` (no existe) ‚Üí Corregido a `received_at`\r\n\r\n**Soluci√≥n**:\r\n- Migraci√≥n `fix_payment_trigger_enum`: Usa correctamente el enum `app.payment_method`\r\n- Mapea `mercadopago` ‚Üí `mp` (valor del enum)\r\n\r\n### 3. **Hook usePayments** ‚úÖ SOLUCIONADO\r\n**Problema**: El hook consultaba columnas incorrectas:\r\n- Consultaba `payment_method` y `processed_at` ‚Üí Corregido a `method` y `received_at`\r\n\r\n**Soluci√≥n**:\r\n- Actualizado `src/hooks/usePayments.ts` para usar los nombres correctos de columnas\r\n\r\n## üìä Verificaci√≥n Final\r\n\r\n### Estado de la Base de Datos\r\n```sql\r\n-- Turno completado\r\nSELECT \r\n  a.id,\r\n  a.total_amount,  -- $3,500\r\n  a.status,        -- 'completed'\r\n  a.employee_id,   -- Nacho Angelone (50% comisi√≥n)\r\n  a.payment_method -- 'cash'\r\nFROM app.appointments a\r\nWHERE a.id = '67f53b7c-ca40-4a9d-b82e-5e7ccc0fed5b';\r\n\r\n-- Pago creado autom√°ticamente\r\nSELECT \r\n  p.id,\r\n  p.amount,        -- $3,500\r\n  p.method,        -- 'cash'\r\n  p.received_at\r\nFROM app.payments p\r\nWHERE p.appointment_id = '67f53b7c-ca40-4a9d-b82e-5e7ccc0fed5b';\r\n\r\n-- Comisi√≥n creada autom√°ticamente\r\nSELECT \r\n  c.id,\r\n  c.amount,        -- $1,750 (50% de $3,500)\r\n  c.pct,           -- 50.00\r\n  c.appointment_item_id\r\nFROM app.commissions c\r\nWHERE c.appointment_id = '67f53b7c-ca40-4a9d-b82e-5e7ccc0fed5b';\r\n```\r\n\r\n### Estado de la Interfaz\r\n- ‚úÖ **Dashboard**: Muestra \"Comisiones Hoy: $1,750.00\"\r\n- ‚úÖ **Trigger de pagos**: Crea pago autom√°ticamente al completar turno\r\n- ‚úÖ **Trigger de comisiones**: Crea comisi√≥n autom√°ticamente al completar turno\r\n- ‚úÖ **Hook usePayments**: Consulta correctamente los campos de la BD\r\n\r\n## üéØ Resultado Final\r\n\r\nAl completar un turno:\r\n1. ‚úÖ Se crea autom√°ticamente un **pago** con el `total_amount` del servicio\r\n2. ‚úÖ Se crea autom√°ticamente una **comisi√≥n** para el empleado (seg√∫n su porcentaje o monto fijo)\r\n3. ‚úÖ Los c√°lculos financieros reflejan correctamente:\r\n   - Ingresos Totales = suma de pagos\r\n   - Comisiones = suma de comisiones\r\n   - Resultado Neto = Ingresos - Gastos - Comisiones\r\n\r\n## üìù Migraciones Aplicadas\r\n\r\n1. `fix_commission_trigger_corrected` - Corrige campos del trigger de comisiones\r\n2. `fix_payment_trigger_enum` - Corrige el uso del enum en trigger de pagos\r\n3. `fix_commission_trigger_create_item` - Crea appointment_item autom√°ticamente si no existe\r\n\r\n## üîß Cambios en C√≥digo\r\n\r\n1. `src/hooks/usePayments.ts` - Actualizado para usar `method` y `received_at` en lugar de `payment_method` y `processed_at`\r\n\r\n---\r\n\r\n## 2025-11-13 ‚Äì Actualizaci√≥n de estados y finanzas\r\n\r\n### ‚úÖ Cambios aplicados\r\n- Se actualiz√≥ la funci√≥n `public.update_appointment_status` en `infra/db/schema.sql` para castear `p_status::appointment_status` y retroceder a texto cuando la tabla todav√≠a usa `text`.\r\n- `src/hooks/useAppointments.ts` normaliza las respuestas de los RPC (`update_appointment_status` y `update_appointment_rpc`) y a√±ade errores gu√≠a si la funci√≥n sigue en una versi√≥n antigua.\r\n- La navegaci√≥n a ‚ÄúFinanzas‚Äù usa el `case \"finances\"` de `App.tsx`, por lo que ya se renderiza `FinancesView` completo con tabs y m√©tricas alimentadas por `useFinancialMetrics`.\r\n\r\n### üöß Pendiente\r\n- Ejecutar las migraciones de Supabase para que la nueva versi√≥n de `update_appointment_status` quede activa en el entorno real (sin ese cast el cambio de estado sigue fallando).\r\n- Repetir la prueba manual: completar un turno remoto, verificar que Home y Finanzas actualicen KPIs y, si aplica, registrar un pago para validar los c√°lculos.\r\n\r\n",
  "sections": []
}