{
  "metadata": {
    "title": "Guía Completa de Testing - Mercado Pago",
    "path": "docs/MERCADOPAGO_TESTING.md",
    "category": "testing",
    "tags": [
      "testing"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "MERCADOPAGO_TESTING"
  },
  "content": "# Guía Completa de Testing - Mercado Pago\r\n\r\n## ✅ Estado Actual - TODO COMPLETADO\r\n\r\n### Configuración Completada\r\n\r\n- ✅ **Tabla `app.payment_links`** creada (migración aplicada vía MCP)\r\n- ✅ **Tabla `app.mercadopago_credentials`** existe\r\n- ✅ **Tabla `app.mp_payments`** existe\r\n- ✅ **7 Secrets configurados** en Supabase:\r\n  - `MP_CLIENT_ID`\r\n  - `MP_CLIENT_SECRET`\r\n  - `MP_WEBHOOK_SECRET`\r\n  - `MP_TOKEN_KEY`\r\n  - `PUBLIC_EDGE_BASE_URL`\r\n  - `NEXT_PUBLIC_APP_URL`\r\n  - `SERVICE_ROLE_KEY`\r\n- ✅ **11 Edge Functions actualizadas y desplegadas**:\r\n  - `auth-mp-connect` ✅ Actualizada\r\n  - `public-auth-mp-callback` ✅ Renombrada y actualizada\r\n  - `mp-disconnect` ✅\r\n  - `mp-create-preference` ✅\r\n  - `mercadopago-webhook` ✅\r\n  - `create-payment-link` ✅\r\n  - `get-payment-link-config` ✅ **Actualizada y desplegada - Requiere Google Auth**\r\n  - `public-get-salon-services` ✅ **Actualizada y desplegada - Requiere Google Auth**\r\n  - `public-get-salon-stylists` ✅ **Actualizada y desplegada - Requiere Google Auth**\r\n  - `public-get-availability` ✅ **Actualizada y desplegada - Requiere Google Auth**\r\n  - `public-create-appointment` ✅ **Actualizada y desplegada - Requiere Google Auth**\r\n- ✅ **Archivo `.env.local`** creado con todas las variables\r\n- ✅ **Webhook configurado en Mercado Pago** (modo prueba):\r\n  - URL: `https://hawpywnmkatwlcbtffrg.supabase.co/functions/v1/mercadopago-webhook`\r\n  - Eventos: Pagos, Vinculación de aplicaciones, Alertas de fraude, Reclamos, Card Updater, Contracargos, Order, Órdenes comerciales\r\n  - Clave secreta configurada\r\n- ✅ **Autenticación con Google OAuth implementada**:\r\n  - ✅ Página de checkout requiere autenticación con Google\r\n  - ✅ Callback redirige automáticamente al checkout después de autenticarse\r\n  - ✅ Hook `usePublicCheckout` envía token de autenticación en todas las requests\r\n  - ✅ Edge Functions públicas requieren header `Authorization: Bearer <token>`\r\n\r\n---\r\n\r\n## Credenciales de Prueba\r\n\r\n### Cuentas Test\r\n- **Vendedor:** `TESTUSER5830222553060724396` / `yCM6rFsIDZ`\r\n- **Comprador:** `TESTUSER3530837555863106944` / `mslnqrN49W`\r\n\r\n### API Credentials (Sandbox)\r\n```env\r\nMP_CLIENT_ID=311317450627289\r\nMP_CLIENT_SECRET=ACAOfFSl4KkULdcRE6WlUUHMNwmqrVvq\r\nMP_WEBHOOK_SECRET=903fdd0640d1353e6ba6a9051798e93efd4ef39054a1699c2dc577511217dc5d\r\nMP_TOKEN_KEY=f9d2b8a0e1c4b39f772c5a6d84f09e3b51a27cb08e6d9354a7dcb61f92ad4b03\r\n```\r\n\r\n### Tarjetas de Prueba\r\n- **Aprobada:** `5031 7557 3453 0604` (CVV: 123, Fecha: 11/25)\r\n- **Rechazada:** `5031 4332 1540 6351` (CVV: 123, Fecha: 11/25)\r\n- **Pendiente:** `5031 7557 3453 0604` (CVV: 123, Fecha: 11/25) - Para pagos con revisión manual\r\n\r\n---\r\n\r\n## ✅ Cambios Implementados: Autenticación con Google OAuth\r\n\r\n### Resumen de Cambios\r\n\r\n1. **Página de Checkout (`pages/book/[token].tsx`)**:\r\n   - ✅ Requiere autenticación con Google antes de mostrar el checkout\r\n   - ✅ Muestra botón \"Continuar con Google\" si no hay sesión\r\n   - ✅ Guarda el token del payment link en sessionStorage para redirigir después de la autenticación\r\n\r\n2. **Callback de Autenticación (`pages/auth/callback.tsx`)**:\r\n   - ✅ Detecta si hay un token de payment link pendiente\r\n   - ✅ Redirige automáticamente al checkout después de autenticarse con Google\r\n\r\n3. **Hook `usePublicCheckout` (`src/hooks/usePublicCheckout.ts`)**:\r\n   - ✅ Obtiene el token de sesión de Supabase\r\n   - ✅ Envía el token en el header `Authorization: Bearer <token>` en todas las requests a las Edge Functions\r\n\r\n4. **Edge Functions Públicas**:\r\n   - ✅ `get-payment-link-config`: Requiere header de autorización\r\n   - ✅ `public-get-salon-services`: Requiere header de autorización\r\n   - ✅ `public-get-salon-stylists`: Requiere header de autorización\r\n   - ✅ `public-get-availability`: Requiere header de autorización\r\n   - ✅ `public-create-appointment`: Requiere header de autorización\r\n\r\n5. **Exportación de `getClient`**:\r\n   - ✅ Exportado desde `src/lib/supabase.ts` para usar en el hook\r\n\r\n### ✅ Despliegue de Edge Functions Completado\r\n\r\nLas Edge Functions han sido actualizadas y desplegadas exitosamente:\r\n\r\n- ✅ `get-payment-link-config` - Desplegada\r\n- ✅ `public-get-salon-services` - Desplegada\r\n- ✅ `public-get-salon-stylists` - Desplegada\r\n- ✅ `public-get-availability` - Desplegada\r\n- ✅ `public-create-appointment` - Desplegada\r\n\r\n**Dashboard de Supabase:** https://supabase.com/dashboard/project/hawpywnmkatwlcbtffrg/functions\r\n\r\n---\r\n\r\n## Testing End-to-End Completo\r\n\r\n### Flujo Completo de Testing (5 Pasos)\r\n\r\n#### Paso 1: Verificar Conexión OAuth ✅\r\n\r\n**Objetivo:** Verificar que la integración OAuth funciona correctamente.\r\n\r\n1. **Abrir CRM:**\r\n   - Ir a `https://coreboard.vercel.app` (o localhost si está corriendo)\r\n   - Login con cuenta de organización\r\n\r\n2. **Navegar a Configuración:**\r\n   - CRM → Configuración → Mercado Pago\r\n   - Click en \"Conectar con Mercado Pago\"\r\n\r\n3. **Completar OAuth:**\r\n   - Será redirigido a Mercado Pago\r\n   - **Login con cuenta vendedor:** `TESTUSER5830222553060724396` / `yCM6rFsIDZ`\r\n   - Autorizar la aplicación\r\n   - Será redirigido de vuelta al CRM\r\n\r\n4. **Verificar Estado:**\r\n   - Debe mostrar \"Conectado\" en lugar de \"Conectar\"\r\n   - Verificar en BD: `SELECT * FROM app.mercadopago_credentials WHERE org_id = 'tu_org_id'`\r\n   - Debe existir un registro con `access_token` y `refresh_token`\r\n\r\n**✅ Verificación Exitosa:**\r\n- Estado muestra \"Conectado\"\r\n- Credenciales guardadas en BD\r\n- Token de acceso válido\r\n\r\n---\r\n\r\n#### Paso 2: Generar Payment Link ✅\r\n\r\n**Objetivo:** Verificar que la generación de payment links funciona.\r\n\r\n1. **Abrir Modal de Payment Link:**\r\n   - CRM → Click en botón \"Generar Link de Pago\" (o donde esté disponible)\r\n   - Se abre modal `PaymentLinkModal`\r\n\r\n2. **Completar Formulario:**\r\n   - Seleccionar **Salón** (requerido)\r\n   - Ingresar **Título** (ej: \"Reserva tu turno\")\r\n   - Ingresar **Descripción** (opcional)\r\n   - Click en \"Generar Link\"\r\n\r\n3. **Verificar Resultado:**\r\n   - Debe aparecer un link: `https://coreboard.vercel.app/book/[token]`\r\n   - El token debe ser una cadena hexadecimal de 64 caracteres\r\n   - Click en \"Copiar\" debe copiar el link al portapapeles\r\n\r\n4. **Verificar en BD:**\r\n   ```sql\r\n   SELECT * FROM app.payment_links \r\n   WHERE org_id = 'tu_org_id' \r\n   ORDER BY created_at DESC \r\n   LIMIT 1;\r\n   ```\r\n   - Debe existir un registro con `token_hash`, `title`, `active = true`\r\n   - `expires_at` debe ser ~30 días en el futuro\r\n\r\n**✅ Verificación Exitosa:**\r\n- Link generado correctamente\r\n- Token único y válido\r\n- Registro creado en BD\r\n- Link copiable\r\n\r\n---\r\n\r\n#### Paso 3: Probar Checkout Público (Flujo Completo) ✅\r\n\r\n**Objetivo:** Verificar que el checkout público funciona end-to-end.\r\n\r\n1. **Abrir Payment Link:**\r\n   - Abrir el link generado en **modo incógnito** (navegador privado)\r\n   - URL: `https://coreboard.vercel.app/book/[token]`\r\n   - Debe cargar la página de checkout público\r\n\r\n2. **Completar Stepper Paso a Paso:**\r\n\r\n   **Paso 1: Seleccionar Servicio**\r\n   - Debe mostrar lista de servicios del salón\r\n   - Seleccionar un servicio (ej: \"Corte de cabello\")\r\n   - Click en \"Siguiente\"\r\n\r\n   **Paso 2: Seleccionar Estilista**\r\n   - Debe mostrar lista de estilistas disponibles\r\n   - Seleccionar un estilista (o \"Cualquiera\")\r\n   - Click en \"Siguiente\"\r\n\r\n   **Paso 3: Seleccionar Fecha**\r\n   - Debe mostrar calendario con fechas disponibles\r\n   - Seleccionar una fecha futura\r\n   - Click en \"Siguiente\"\r\n\r\n   **Paso 4: Seleccionar Hora**\r\n   - Debe mostrar horarios disponibles para la fecha seleccionada\r\n   - Seleccionar un horario (ej: \"10:00\")\r\n   - Click en \"Siguiente\"\r\n\r\n   **Paso 5: Completar Datos**\r\n   - Ingresar **Nombre del cliente** (requerido)\r\n   - Ingresar **Teléfono** (opcional)\r\n   - Ingresar **Email** (opcional)\r\n   - Click en \"Confirmar y Pagar\"\r\n\r\n3. **Verificar Redirección a Mercado Pago:**\r\n   - Debe redirigir a checkout de Mercado Pago\r\n   - URL debe ser de Mercado Pago (sandbox)\r\n   - Debe mostrar el monto del servicio\r\n\r\n4. **Completar Pago:**\r\n   - Seleccionar \"Tarjeta de crédito\"\r\n   - Ingresar tarjeta de prueba: `5031 7557 3453 0604`\r\n   - CVV: `123`\r\n   - Fecha: `11/25`\r\n   - Nombre: `APRO`\r\n   - Click en \"Pagar\"\r\n\r\n5. **Verificar Redirección:**\r\n   - Debe redirigir a `/payment/success?appointment_id=[id]`\r\n   - Debe mostrar mensaje de éxito\r\n   - El turno debe estar confirmado en BD\r\n\r\n**✅ Verificación Exitosa:**\r\n- Checkout carga correctamente\r\n- Todos los pasos del stepper funcionan\r\n- Redirección a Mercado Pago funciona\r\n- Pago se procesa correctamente\r\n- Turno se crea y confirma en BD\r\n\r\n---\r\n\r\n#### Paso 4: Verificar Webhook ✅\r\n\r\n**Objetivo:** Verificar que los webhooks de Mercado Pago se procesan correctamente.\r\n\r\n1. **Revisar Logs de Edge Function:**\r\n   - Ir a Supabase Dashboard → Edge Functions → `mercadopago-webhook` → Logs\r\n   - Debe haber logs de notificaciones recibidas\r\n\r\n2. **Verificar en BD:**\r\n   ```sql\r\n   -- Verificar turno confirmado\r\n   SELECT * FROM app.appointments \r\n   WHERE id = 'appointment_id_del_pago'\r\n   AND status = 'confirmed';\r\n   \r\n   -- Verificar registro de pago\r\n   SELECT * FROM app.mp_payments \r\n   WHERE appointment_id = 'appointment_id_del_pago'\r\n   ORDER BY created_at DESC;\r\n   ```\r\n\r\n3. **Simular Webhook Manualmente (Opcional):**\r\n   - Ir a Mercado Pago Dashboard → Webhooks → \"Simular notificación\"\r\n   - Seleccionar evento: `payment`\r\n   - Data ID: ID del pago de prueba\r\n   - Click en \"Enviar prueba\"\r\n   - Verificar que llega al webhook\r\n\r\n**✅ Verificación Exitosa:**\r\n- Webhooks se reciben correctamente\r\n- Turnos se confirman automáticamente\r\n- Pagos se registran en BD\r\n\r\n---\r\n\r\n#### Paso 5: Probar Casos Edge ✅\r\n\r\n**Objetivo:** Verificar casos límite y errores.\r\n\r\n1. **Payment Link Expirado:**\r\n   - Crear link con fecha de expiración pasada\r\n   - Intentar acceder → Debe mostrar error \"Link expirado\"\r\n\r\n2. **Payment Link Inactivo:**\r\n   - Desactivar link en BD: `UPDATE app.payment_links SET active = false WHERE token_hash = '...'`\r\n   - Intentar acceder → Debe mostrar error \"Link no disponible\"\r\n\r\n3. **Pago Rechazado:**\r\n   - Completar checkout hasta pago\r\n   - Usar tarjeta rechazada: `5031 4332 1540 6351`\r\n   - Debe redirigir a `/payment/failure`\r\n   - Turno debe quedar en estado `pending` o `cancelled`\r\n\r\n4. **Sin Servicios Disponibles:**\r\n   - Desactivar todos los servicios del salón\r\n   - Intentar acceder al link → Debe mostrar mensaje apropiado\r\n\r\n5. **Sin Horarios Disponibles:**\r\n   - Seleccionar fecha sin horarios disponibles\r\n   - Debe mostrar mensaje \"No hay horarios disponibles\"\r\n\r\n**✅ Verificación Exitosa:**\r\n- Todos los casos edge se manejan correctamente\r\n- Mensajes de error apropiados\r\n- No hay crashes o errores 500\r\n\r\n---\r\n\r\n## Verificación Post-Testing\r\n\r\n### Checklist de Verificación\r\n\r\n```bash\r\n# 1. Verificar Edge Functions desplegadas\r\nsupabase functions list --project-ref hawpywnmkatwlcbtffrg\r\n\r\n# 2. Verificar secrets configurados\r\nsupabase secrets list --project-ref hawpywnmkatwlcbtffrg\r\n\r\n# 3. Verificar tablas en BD (ejecutar en Supabase SQL Editor)\r\nSELECT table_name FROM information_schema.tables \r\nWHERE table_schema = 'app' \r\nAND table_name IN ('mercadopago_credentials', 'mp_payments', 'payment_links');\r\n\r\n# 4. Verificar registros creados\r\nSELECT COUNT(*) FROM app.mercadopago_credentials;\r\nSELECT COUNT(*) FROM app.payment_links;\r\nSELECT COUNT(*) FROM app.mp_payments;\r\n```\r\n\r\n---\r\n\r\n## Troubleshooting\r\n\r\n| Error | Causa Probable | Solución |\r\n|-------|---------------|----------|\r\n| \"No hay cuenta conectada\" | OAuth no completado | Completar OAuth desde CRM |\r\n| \"Token inválido\" | Payment link no existe o expirado | Verificar en BD: `SELECT * FROM app.payment_links WHERE token_hash = '...'` |\r\n| \"Webhook no llega\" | URL incorrecta o secreto incorrecto | Verificar URL en MP dashboard y `MP_WEBHOOK_SECRET` |\r\n| \"Edge Function no encontrada\" | Función no desplegada | Desplegar con `supabase functions deploy [nombre]` |\r\n| \"Error creando preferencia\" | Token de acceso inválido | Verificar que OAuth está completo y token no expiró |\r\n| \"Turno no se confirma\" | Webhook no procesa correctamente | Revisar logs de `mercadopago-webhook` en Supabase |\r\n\r\n---\r\n\r\n## Logs y Monitoreo\r\n\r\n### Ver Logs de Edge Functions\r\n\r\n1. **Supabase Dashboard:**\r\n   - Edge Functions → Seleccionar función → Logs\r\n   - Filtrar por fecha/hora\r\n\r\n2. **Mercado Pago Dashboard:**\r\n   - Webhooks → Ver historial de notificaciones\r\n   - Verificar estado de entrega (éxito/fallo)\r\n\r\n### Métricas a Monitorear\r\n\r\n- ✅ Tasa de éxito de OAuth\r\n- ✅ Tasa de generación de payment links\r\n- ✅ Tasa de conversión de checkout (visitas → pagos)\r\n- ✅ Tiempo de respuesta de webhooks\r\n- ✅ Tasa de éxito de pagos\r\n\r\n---\r\n\r\n## Testing en Producción (Preparación)\r\n\r\nVer sección **\"Preparación para Producción\"** en `SETUP_COMPLETO.md` para:\r\n- Cambio de credenciales de prueba a producción\r\n- Configuración de webhooks en producción\r\n- Testing final antes de lanzar\r\n\r\n---\r\n\r\n**Última actualización:** Configuración completada ✅ - Listo para testing end-to-end\r\n",
  "sections": []
}