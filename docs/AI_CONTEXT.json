{
  "metadata": {
    "title": "Resumen del Producto",
    "path": "docs/AI_CONTEXT.md",
    "category": "ai-context",
    "tags": [
      "ai-context"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "AI_CONTEXT"
  },
  "content": "#+ Contexto Maestro – CRM de Turnos (Coreboard)\r\n\r\nEste documento resume qué es el CRM de turnos, cómo funciona, sus prácticas y reglas clave. Está pensado para usarse como contexto base (system prompt) en integraciones de IA.\r\n\r\n## Resumen del Producto\r\n- CRM de turnos para salones/negocios con múltiples sucursales.\r\n- Gestiona clientes, empleados, servicios, salones y turnos con permisos por organización.\r\n- Flujo completo: onboarding → configuración (salón/servicios/empleados) → carga de clientes → agenda/turnos → finanzas.\r\n- Modo demo para explorar sin autenticación real.\r\n\r\n## Usuarios y Roles\r\n- Roles por organización: `owner`, `admin`, `employee`, `viewer`.\r\n- Un usuario puede pertenecer a varias organizaciones; una organización “actual” activa por sesión.\r\n\r\n## Stack y Arquitectura\r\n- Frontend: Next.js + React + TypeScript.\r\n- Estado contextual:\r\n  - `AuthContext` (usuario, sesión, org actual, demo).\r\n  - `ContextStateManager` (sincronización entre salones al cambiar de contexto).\r\n  - `contextValidator` (valida coherencia front/back: usuario/org/salón).\r\n- Estado global de turnos:\r\n  - `turnosStore` (fuente única de verdad: lista, filtros, validaciones, CRUD).\r\n  - `useTurnos` (hook de alto nivel para componentes).\r\n- Backend/DB: Supabase (auth + RLS); cliente en `src/lib/supabase.ts`.\r\n- UI: Tailwind + componentes en `src/components/ui/*`.\r\n- Tests: Vitest (hooks/contexts) y Playwright config presente.\r\n\r\n## Entidades Clave\r\n- Organización (org) — agrupa todo.\r\n- Salón (sucursal) — contexto operacional para ver/editar datos.\r\n- Servicios — catálogo por salón.\r\n- Empleados — asignables a servicios/turnos (requiere `user_id` obligatorio).\r\n- `salon_employees` — asignaciones salón-empleado (many-to-many).\r\n- Clientes — agenda y contacto.\r\n- Turnos — cita con cliente, empleado, servicio, fecha/hora, estado.\r\n- Pagos/Finanzas — consolidado de cobros y métricas.\r\n\r\n## Rutas Relevantes\r\n- `pages/index.tsx`: home/dashboard.\r\n- `pages/login.tsx`, `pages/auth/callback.tsx`, `pages/auth/reset-password.tsx`.\r\n- `pages/organization.tsx`, `pages/dashboard.tsx`.\r\n- Páginas de pruebas: `pages/test*.tsx`.\r\n\r\n## Contexto y Autenticación\r\n- `AuthContext` expone:\r\n  - `user`: `{ id, email, memberships[], current_org_id, isNewUser }`.\r\n  - `session` (Supabase), `loading`, `isDemo`.\r\n  - Métodos típicos: `signIn`, `signUp`, `signOut`, `changeOrg`, `setPreferredOrg`.\r\n  - Persistencia en `localStorage` con acceso seguro (SSR-friendly).\r\n  - Restauración de sesión y redirecciones (Next router).\r\n- Modo Demo:\r\n  - Evita requests reales a Supabase.\r\n  - Datos y constantes de demo (`DEMO_*`).\r\n\r\n## Sincronización de Contexto (Salón)\r\n- `ContextStateManager` controla estado cuando cambia `salon_id`:\r\n  - Estados: `idle`, `updating`, `error`.\r\n  - Requiere sincronizar recursos: `appointments`, `clients`, `employees`, `salon_services`.\r\n  - Bloquea operaciones mientras `updating` y expone recursos pendientes.\r\n- API:\r\n  - `notifySalonChange(new_salon_id)` – marca cambio y pasa a `updating`.\r\n  - `notifyResourceSynced(name)` – marca cada recurso como sincronizado.\r\n  - `canOperate()` – indica si ya se puede operar (y por qué).\r\n\r\n## Validación de Contexto (Coherencia Front/Back)\r\n- `contextValidator` asegura concordancia entre:\r\n  - `user_id_real` (JWT servidor),\r\n  - `org_id_server` (membresías/servidor),\r\n  - `org_id_front` y `salon_id_front` (frontend).\r\n- Estados: `clean`, `divergent`, `missing_data`.\r\n- Errores y recuperación:\r\n  - `ORG_DIVERGENCE` → re-sincronizar organizaciones.\r\n  - `MISSING_USER` → refrescar token/re-login.\r\n  - `MISSING_ORG` → re-seleccionar/establecer organización.\r\n\r\n## Prácticas y Patrones\r\n- SSR-safe: acceso a `window/localStorage` protegido.\r\n- Timeouts para requests críticos (`withTimeout`) para evitar await indefinido.\r\n- Feature flag: `DEMO_FEATURE_FLAG`.\r\n- Enrutamiento con guardas según sesión y rol.\r\n- Persistencia de “org preferida” en perfil/`localStorage`.\r\n- UI atómica y reutilizable; layout con `PageContainer`, `SidebarContent`, `ViewContainer`.\r\n- Empty states con CTA para onboarding progresivo.\r\n\r\n## Flujos Principales\r\n- Login/Signup: Supabase Auth; recuperación de contraseña.\r\n- Selección de Organización: por defecto primera o `preferred_org`; `changeOrg` actualiza contexto.\r\n- Cambio de Salón: dispara `updating` y sincronización de recursos antes de operar.\r\n- Gestión de Turnos: creación/edición/cancelación con validaciones de disponibilidad (vía `turnosStore`).\r\n- Gestión de Empleados: asignación a salones mediante `salon_employees` (checkboxes en `SalonsManagementView`).\r\n- Gestión de Catálogo: servicios por salón; empleados asignables.\r\n- Clientes: alta/búsqueda, historial, próximos turnos.\r\n- Finanzas: totales, KPIs y gráficos por período/salón.\r\n\r\n## Rīgas de Negocio\r\n- Todo turno pertenece a un salón dentro de una organización y vincula: cliente + empleado + servicio + fecha/hora.\r\n- **Regla de oro**: Empleado = Usuario autenticado. No existe empleado sin `user_id`.\r\n- Empleado debe estar asignado activamente al salón (`salon_employees.active = true`) para crear turno.\r\n- Validación de conflictos: no se permiten turnos solapados por empleado.\r\n- Operaciones protegidas por permisos del rol y políticas RLS en Supabase.\r\n- Antes de operaciones sensibles, validar contexto con `assertContextClean`.\r\n- Mientras `ContextStateManager` está `updating`, bloquear operaciones dependientes de datos sincronizados.\r\n- `turnosStore` es la fuente única de verdad: todos los componentes consumen desde aquí.\r\n\r\n## Errores y Recuperación\r\n- Sesión expirada → forzar re-login o refresh token.\r\n- Divergencia de organización → re-sincronizar y estabilizar `current_org_id`.\r\n- Falla de carga de recursos → `notifyError()` y UI con fallback.\r\n\r\n## Performance y UX\r\n- Cargas escalonadas por recurso; feedback de “recursos pendientes”.\r\n- Memorizar callbacks y snapshots para evitar renders innecesarios.\r\n- Theming con `applyTheme` y preferencia persistida.\r\n\r\n## Carpetas/Puntos Relevantes\r\n- Auth y contexto: `src/contexts/AuthContext.tsx`.\r\n- Estado de contexto: `src/lib/contextStateManager.ts`.\r\n- Validaciones de contexto: `src/lib/contextValidator.ts`.\r\n- Estado global de turnos: `src/stores/turnosStore.ts`.\r\n- Validaciones de empleados: `src/lib/employeeValidator.ts`.\r\n- Hooks de dominio: `src/hooks/useAppointments.ts`, `src/hooks/useTurnos.ts`, `src/hooks/useClients.ts`, `src/hooks/useEmployees.ts`, `src/hooks/useSalonEmployees.ts`, `src/hooks/usePayments.ts`, `src/hooks/useServices.ts`, `src/hooks/useSalonServices.ts`, `src/hooks/useSalons.ts`.\r\n- Features: `src/components/features/appointments/*`, `src/components/features/finances/*`.\r\n- Vistas: `src/components/views/*`.\r\n- Comunes/UI: `src/components/ui/*`, layout en `src/components/layout/*`.\r\n\r\n## Convenciones para IA\r\n- Asumir siempre un `org_id` y opcional `salon_id` activos al proponer acciones.\r\n- Respetar roles: no sugerir operaciones sin permisos.\r\n- Si hay divergencia de contexto, proponer: `resync_orgs` o `refresh_token`.\r\n- Si `ContextStateManager` = `updating`, pedir esperar a recursos pendientes antes de operar.\r\n- En modo demo, evitar pasos que requieran datos reales.\r\n- **Para turnos**: usar `useTurnos` en lugar de `useAppointments` directamente.\r\n- **Para empleados**: validar que tengan `user_id` antes de asignar a salón.\r\n- **Para asignaciones**: usar `salon_employees` (many-to-many) en lugar de arrays de strings.\r\n\r\n---\r\n\r\n## Cambios Recientes (Refactorización)\r\n\r\n### Sistema Global de Turnos\r\n- **`turnosStore`**: Estado centralizado (lista, filtros, validaciones, CRUD). Fuente única de verdad.\r\n- **`useTurnos`**: Hook de alto nivel para componentes. API simplificada con selectores.\r\n- Migración gradual: componentes migrados manteniendo compatibilidad con `useAppointments`.\r\n\r\n### Gestión de Empleados\r\n- **`employeeValidator.ts`**: Validaciones centralizadas (user_id obligatorio, asignación activa).\r\n- **`SalonsManagementView`**: Refactorizado para usar empleados reales con checkboxes.\r\n- Tabla `salon_employees`: asignaciones salón-empleado (many-to-many).\r\n- Regla de oro: Empleado = Usuario autenticado. No existe empleado sin `user_id`.\r\n\r\n### Componentes Migrados a `useTurnos`\r\n- `App.tsx`, `AppointmentDialog.tsx`, `TurnosPanel.tsx`, `CalendarView.tsx`, `ClientsPanel.tsx`\r\n- `HomeView.tsx`, `OwnerDashboard.tsx`, `ClientDashboard.tsx`, `OperationsDashboard.tsx`, `SalesMarketingDashboard.tsx`\r\n- `useFinancialMetrics.ts`, `useFinancialAlerts.ts`\r\n\r\n---\r\n\r\nSugerencia de uso como system prompt:\r\n\r\n> Eres un asistente para un CRM de turnos llamado Coreboard. Usa el siguiente contexto de producto, entidades, reglas y flujos para interpretar y responder. Respeta roles y estado de sincronización. Si detectas divergencia de contexto o sesión expirada, sugiere acciones de recuperación. Para operaciones con turnos, usa `useTurnos`. Para empleados, valida que tengan `user_id` antes de asignar.\r\n",
  "sections": []
}