{
  "metadata": {
    "title": "Verificación: Comisiones y Pagos al Completar Turnos",
    "path": "docs/VERIFICACION_COMISIONES_PAGOS.md",
    "category": "verification",
    "tags": [
      "verification"
    ],
    "lastUpdated": "2025-11-15",
    "fileName": "VERIFICACION_COMISIONES_PAGOS"
  },
  "content": "# Verificación: Comisiones y Pagos al Completar Turnos\r\n\r\n## Problema Identificado\r\n\r\nAl completar un turno, se debe:\r\n1. ✅ **Crear el pago automáticamente** con el `total_amount` del turno\r\n2. ❌ **Crear la comisión automáticamente** para el empleado (stylist)\r\n3. ✅ **Restar la comisión** en los cálculos financieros\r\n\r\n## Estado Actual\r\n\r\n### ✅ Pago Automático (FUNCIONA)\r\n- **Trigger**: `generate_payment_on_complete_trigger`\r\n- **Función**: `app.generate_payment_on_complete()`\r\n- **Ubicación**: `infra/db/schema.sql` líneas 556-617\r\n- **Funcionalidad**: \r\n  - Se ejecuta cuando `status = 'completed'`\r\n  - Crea un pago con `amount = total_amount` del appointment\r\n  - Usa el `payment_method` del appointment\r\n\r\n### ❌ Comisión Automática (NECESITA CORRECCIÓN)\r\n- **Trigger**: `generate_commission_on_complete_trigger`\r\n- **Función**: `app.generate_commission_on_complete()`\r\n- **Ubicación**: `infra/db/migrations/fix_finances_crud.sql` líneas 106-199\r\n- **Problema**: \r\n  - El trigger intenta insertar campos que no existen:\r\n    - `appointment_item_id` ❌ (no existe en `app.commissions`)\r\n    - `pct` ❌ (debe ser `commission_pct`)\r\n  - La tabla `app.commissions` usa `commission_pct`, no `pct`\r\n\r\n### ✅ Cálculos Financieros (CORRECTO)\r\n- **Ubicación**: `src/hooks/useFinancialMetrics.ts`\r\n- **Cálculo**:\r\n  ```typescript\r\n  // Costos directos: comisiones\r\n  const directCosts = commissions.reduce((sum, comm) => sum + comm.amount, 0);\r\n  \r\n  // Margen bruto: ingreso neto - costos directos\r\n  const grossMargin = netRevenue - directCosts;\r\n  ```\r\n- ✅ **Correcto**: Las comisiones se restan del `netRevenue` para obtener `grossMargin`\r\n\r\n## Solución\r\n\r\n### 1. Migración SQL Corregida\r\nSe creó `infra/db/migrations/fix_commission_trigger.sql` que:\r\n- ✅ Usa los campos correctos de `app.commissions`:\r\n  - `commission_pct` (no `pct`)\r\n  - No usa `appointment_item_id`\r\n- ✅ Calcula la comisión correctamente:\r\n  - Si `commission_type = 'fixed'`: usa `default_commission_amount`\r\n  - Si `commission_type = 'percentage'` (o NULL): usa `default_commission_pct * total_amount / 100`\r\n- ✅ Asegura que el trigger esté activo\r\n\r\n### 2. Campos de la Tabla `app.commissions`\r\n```sql\r\nCREATE TABLE app.commissions (\r\n  id uuid PRIMARY KEY,\r\n  org_id uuid NOT NULL,\r\n  employee_id uuid NOT NULL,\r\n  appointment_id uuid,\r\n  amount numeric NOT NULL,\r\n  commission_pct numeric NOT NULL,  -- ✅ Campo correcto\r\n  calculated_at timestamptz,\r\n  date date,\r\n  created_at timestamptz\r\n);\r\n```\r\n\r\n### 3. Flujo Completo al Completar Turno\r\n\r\n1. **Usuario completa turno** → `status = 'completed'`\r\n2. **Trigger `generate_payment_on_complete`**:\r\n   - Crea pago con `amount = total_amount`\r\n   - ✅ **Ingreso sumado correctamente**\r\n3. **Trigger `generate_commission_on_complete`** (después de aplicar migración):\r\n   - Calcula comisión según `commission_type` del empleado\r\n   - Crea registro en `app.commissions`\r\n   - ✅ **Comisión creada automáticamente**\r\n4. **Cálculos Financieros**:\r\n   - `grossRevenue` = suma de `payments.amount` ✅\r\n   - `netRevenue` = `grossRevenue` - descuentos - impuestos ✅\r\n   - `directCosts` = suma de `commissions.amount` ✅\r\n   - `grossMargin` = `netRevenue` - `directCosts` ✅\r\n   - **Comisión restada correctamente**\r\n\r\n## Pasos para Aplicar\r\n\r\n1. **Ejecutar migración SQL**:\r\n   ```sql\r\n   -- Copiar contenido de infra/db/migrations/fix_commission_trigger.sql\r\n   -- Ejecutar en Supabase SQL Editor\r\n   ```\r\n\r\n2. **Verificar trigger activo**:\r\n   ```sql\r\n   SELECT trigger_name, event_manipulation, event_object_table\r\n   FROM information_schema.triggers\r\n   WHERE trigger_name = 'generate_commission_on_complete_trigger';\r\n   ```\r\n\r\n3. **Probar flujo completo**:\r\n   - Crear un turno con `total_amount > 0`\r\n   - Asignar un stylist con `default_commission_pct > 0`\r\n   - Completar el turno\r\n   - Verificar que se creó:\r\n     - ✅ Un pago con `amount = total_amount`\r\n     - ✅ Una comisión con `amount = total_amount * commission_pct / 100`\r\n   - Verificar en Finanzas:\r\n     - ✅ Ingresos Totales = suma de pagos\r\n     - ✅ Comisiones = suma de comisiones\r\n     - ✅ Resultado Neto = Ingresos - Gastos - Comisiones\r\n\r\n## Resumen\r\n\r\n| Aspecto | Estado | Acción |\r\n|---------|--------|--------|\r\n| Crear pago automático | ✅ Funciona | Ninguna |\r\n| Crear comisión automática | ❌ Necesita corrección | Aplicar migración |\r\n| Restar comisión en cálculos | ✅ Correcto | Ninguna |\r\n| Trigger de comisión activo | ❓ Verificar | Aplicar migración |\r\n\r\n",
  "sections": []
}